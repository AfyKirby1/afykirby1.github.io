<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4a7c59">
    
    <!-- ‚úÖ SECURITY FIX (VULN-006): Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: blob:; connect-src 'self' wss://web-production-b1ed.up.railway.app/ws https://web-production-b1ed.up.railway.app ws://localhost:1234 ws://127.0.0.1:1234; base-uri 'self'; form-action 'self';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Referrer-Policy" content="no-referrer">
    
    <title>Runes of Tir na n√ìg - Prototype</title>
    <link rel="icon" href="../favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon">
    <style>
        body{margin:0;padding:0;background:#4a7c59;font-family:'Courier New',monospace;color:#fff;overflow:hidden;background-image:radial-gradient(circle at 20% 80%,rgba(139,90,43,0.3) 0%,transparent 50%),radial-gradient(circle at 80% 20%,rgba(74,124,89,0.3) 0%,transparent 50%)}

        .game-container{position:relative;width:100vw;height:100vh;margin:0;padding:0;background:#4a7c59;box-sizing:border-box;overflow:hidden}

        #gameCanvas{display:block;width:100%;height:100%;margin:0;padding:0}

        .game-title{position:fixed;top:5px;left:50%;transform:translateX(-50%);font-size:2.2em;font-weight:900;text-align:center;color:#d4af37;text-shadow:2px 2px 0px rgba(139,90,43,0.8),-2px -2px 0px rgba(139,90,43,0.8),4px 4px 8px rgba(0,0,0,0.9),0 0 10px #ff6b35,0 0 20px #ff4500,0 0 30px #ff6347;letter-spacing:2px;z-index:3000;background:linear-gradient(45deg,#8b5a2b,#d4af37,#ffd700,#ffed4e,#d4af37);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;animation:titleFloat 4s ease-in-out infinite,simpleFlame 2s ease-in-out infinite alternate;white-space:nowrap;padding:12px 25px;margin:0;font-family:'Courier New',monospace;text-transform:uppercase}

        .title-sparks {
            position: fixed;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: 100px;
            pointer-events: none;
            z-index: 2999;
            overflow: hidden;
        }

        .spark {
            position: absolute;
            width: 2px;
            height: 2px;
            background: radial-gradient(circle, #ff6b35, #ff4500, #ff6347);
            border-radius: 50%;
            animation: sparkFloat 3s ease-in-out infinite;
            opacity: 0.8;
        }

        @keyframes sparkFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.8; }
            25% { transform: translateY(-10px) rotate(90deg); opacity: 1; }
            50% { transform: translateY(-5px) rotate(180deg); opacity: 0.6; }
            75% { transform: translateY(-15px) rotate(270deg); opacity: 0.9; }
        }

        @keyframes titleFloat {
            0%, 100% { transform: translateX(-50%) translateY(0px); }
            50% { transform: translateX(-50%) translateY(-3px); }
        }

        @keyframes simpleFlame {
            0% { text-shadow: 2px 2px 0px rgba(139,90,43,0.8),-2px -2px 0px rgba(139,90,43,0.8),4px 4px 8px rgba(0,0,0,0.9),0 0 10px #ff6b35,0 0 20px #ff4500,0 0 30px #ff6347; }
            100% { text-shadow: 2px 2px 0px rgba(139,90,43,0.8),-2px -2px 0px rgba(139,90,43,0.8),4px 4px 8px rgba(0,0,0,0.9),0 0 15px #ff6b35,0 0 25px #ff4500,0 0 35px #ff6347; }
        }

        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        .ui-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            font-family: 'Courier New', monospace;
        }

        /* Interactive Controls Bubble */
        .controls-bubble {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(145deg, #8b5a2b, #654321);
            border: 3px solid #d4af37;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            pointer-events: auto;
            z-index: 1001;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
        }

        .controls-bubble:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.6);
            border-color: #ffd700;
        }

        .bubble-icon {
            font-size: 24px;
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.8));
        }

        .bubble-tooltip {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: #d4af37;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .controls-bubble:hover .bubble-tooltip {
            opacity: 1;
        }

        /* Controls Window */
        .controls-window {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            pointer-events: auto;
        }

        .controls-window.show {
            display: flex;
        }

        .controls-content {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.98), rgba(15, 15, 30, 0.98));
            border: 3px solid #d4af37;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 0 40px rgba(212, 175, 55, 0.6);
        }

        .controls-header {
            background: linear-gradient(135deg, #8b5a2b, #654321);
            padding: 20px;
            border-bottom: 2px solid #d4af37;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .controls-header h3 {
            margin: 0;
            color: #d4af37;
            font-size: 1.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .controls-close {
            background: rgba(139, 90, 43, 0.5);
            border: 2px solid #d4af37;
            color: #d4af37;
            font-size: 1.2rem;
            width: 35px;
            height: 35px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .controls-close:hover {
            background: rgba(139, 90, 43, 0.8);
            border-color: #ffd700;
            color: #ffd700;
            transform: scale(1.1);
        }

        .controls-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
            color: #d4af37;
        }

        .controls-body::-webkit-scrollbar {
            width: 12px;
        }

        .controls-body::-webkit-scrollbar-track {
            background: rgba(139, 90, 43, 0.3);
            border-radius: 6px;
        }

        .controls-body::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #d4af37, #8b5a2b);
            border-radius: 6px;
        }

        .controls-body::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #ffd700, #d4af37);
        }

        .control-category {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(212, 175, 55, 0.3);
        }

        .control-category:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .control-category h4 {
            color: #ffd700;
            margin: 0 0 15px 0;
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .control-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            margin: 5px 0;
        }

        .control-action {
            color: #d4af37;
            font-size: 14px;
        }

        .control-key {
            background: linear-gradient(145deg, #2a2a3e, #1a1a2e);
            border: 2px solid #8b7355;
            color: #ffed4e;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            min-width: 60px;
            text-align: center;
        }

        .control-status {
            margin-left: 10px;
            font-size: 16px;
        }

        .control-status.implemented {
            color: #4ade80;
        }

        .control-status.coming-soon {
            color: #ffa500;
        }

        .pause-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            visibility: hidden;
            z-index: 99999;
            font-family: "Courier New", monospace;
            pointer-events: auto;
        }

        .pause-menu.show {
            display: flex;
            visibility: visible;
        }

        .pause-content {
            margin: auto;
            text-align: center;
            background: rgba(139, 90, 43, 0.9);
            padding: 40px;
            border-radius: 15px;
            border: 3px solid #d4af37;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.5);
            min-width: 300px;
        }

        .pause-title {
            font-size: 2.5em;
            color: #d4af37;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .pause-button {
            display: inline-block;
            padding: 15px 30px;
            margin: 10px;
            font-size: 1.2em;
            font-family: "Courier New", monospace;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .pause-button.resume {
            background: #4a7c59;
            color: white;
        }

        .pause-button.resume:hover {
            background: #5a9c69;
            transform: scale(1.05);
        }

        .pause-button.quit {
            background: #8b5a2b;
            color: white;
        }

        .pause-button.quit:hover {
            background: #9b6a3b;
            transform: scale(1.05);
        }

        /* Health Bar Styles */
        .health-bar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            pointer-events: none;
        }

        .heart-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .health-heart {
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            transition: all 0.3s ease;
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.8));
        }

        .health-heart:hover {
            transform: scale(1.1);
        }

        /* Chat System Styles */
        .chat-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 400px;
            height: 300px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #d4af37;
            border-radius: 8px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .chat-message {
            margin-bottom: 5px;
            word-wrap: break-word;
        }

        .chat-message.system {
            color: #d4af37;
            font-style: italic;
        }

        .chat-message.player {
            color: #ffffff;
        }

        .chat-message .username {
            font-weight: bold;
            margin-right: 5px;
        }

        .chat-input-container {
            display: flex;
            padding: 10px;
            border-top: 1px solid #d4af37;
        }

        .chat-input {
            flex: 1;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #d4af37;
            border-radius: 4px;
            padding: 8px;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #ffd700;
        }

        .chat-send {
            background: #d4af37;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            color: #000000;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 5px;
        }

        .chat-send:hover {
            background: #ffd700;
        }

        /* Mobile Controls Styles */
        .mobile-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 15px;
        }

        /* Fullscreen Button */
        .fullscreen-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #d4af37;
            border-radius: 50%;
            color: #d4af37;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2001;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .fullscreen-btn::before {
            content: '‚õ∂';
            font-size: 18px;
        }

        .fullscreen-btn:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: #ffd700;
            color: #ffd700;
            transform: scale(1.05);
        }

        .fullscreen-btn:active {
            transform: scale(0.95);
        }

        /* Hide fullscreen button on desktop */
        @media (hover: hover) and (pointer: fine) {
            .fullscreen-btn {
                display: none !important;
            }
        }

        .mobile-dpad {
            position: relative;
            width: 120px;
            height: 120px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #d4af37;
            border-radius: 50%;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            grid-template-areas: 
                "upLeft up upRight"
                "left center right"
                "downLeft down downRight";
        }

        .dpad-center {
            grid-area: center;
            background: rgba(212, 175, 55, 0.3);
            border-radius: 50%;
            margin: 5px;
        }

        .dpad-btn {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #d4af37;
            color: #d4af37;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .dpad-btn:active {
            background: #d4af37;
            color: #000000;
            transform: scale(0.95);
        }

        .dpad-up { grid-area: up; }
        .dpad-down { grid-area: down; }
        .dpad-left { grid-area: left; }
        .dpad-right { grid-area: right; }
        .dpad-up-left { grid-area: upLeft; }
        .dpad-up-right { grid-area: upRight; }
        .dpad-down-left { grid-area: downLeft; }
        .dpad-down-right { grid-area: downRight; }

        .mobile-chat-btn {
            width: 60px;
            height: 60px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #d4af37;
            border-radius: 50%;
            color: #d4af37;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .mobile-chat-btn:active {
            background: #d4af37;
            color: #000000;
            transform: scale(0.95);
        }

        /* Mobile responsive - show controls on touch devices */
        @media (hover: none) and (pointer: coarse) {
            .mobile-controls {
                display: flex !important;
            }
            
            .fullscreen-btn {
                display: flex !important;
            }
            
            /* Adjust UI elements for mobile */
            .game-title {
                font-size: 1.5em;
                padding: 8px 15px;
            }
            
            .health-bar {
                bottom: 100px; /* Move up to avoid mobile controls */
            }
            
            .chat-container {
                width: calc(100vw - 40px);
                height: 250px;
                bottom: 100px; /* Move up to avoid mobile controls */
            }
            
            .controls-bubble {
                bottom: 100px; /* Move up to avoid mobile controls */
            }
        }

        /* Hide mobile controls on desktop */
        @media (hover: hover) and (pointer: fine) {
            .mobile-controls {
                display: none !important;
            }
            
            .fullscreen-btn {
                display: none !important;
            }
        }

        /* Additional mobile optimizations */
        @media (max-width: 768px) {
            .game-container {
                touch-action: none; /* Prevent default touch behaviors */
            }
            
            canvas {
                touch-action: none;
            }
            
            /* Prevent zoom on double tap */
            * {
                touch-action: manipulation;
            }
            
            /* Larger touch targets */
            .dpad-btn {
                min-height: 44px;
                min-width: 44px;
            }
            
            .mobile-chat-btn {
                min-height: 44px;
                min-width: 44px;
            }
            
            .fullscreen-btn {
                min-height: 44px;
                min-width: 44px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Game Title with Sparks -->
        <div class="game-title" style="display: none;">RUNES OF TIR NA N√ìG</div>
        <div class="title-sparks" id="titleSparks"></div>

        <!-- Game Canvas -->
        <canvas id="gameCanvas"></canvas>

        <!-- UI Overlay -->
        <div class="ui-container">
            <!-- Health Bar -->
            <div id="health-bar" class="health-bar"></div>
            
            <!-- Interactive Controls Bubble -->
            <div class="controls-bubble" id="controlsBubble">
                <div class="bubble-icon">üéÆ</div>
                <div class="bubble-tooltip">Click for Controls</div>
            </div>
        </div>

        <!-- Chat System -->
        <div id="chatContainer" class="chat-container" style="display: none;">
            <div id="chatMessages" class="chat-messages"></div>
            <div class="chat-input-container">
                <input type="text" id="chatInput" class="chat-input" placeholder="Type a message..." maxlength="200">
                <button id="chatSend" class="chat-send">Send</button>
            </div>
        </div>

        <!-- Fullscreen Button (Mobile Only) -->
        <button id="fullscreenBtn" class="fullscreen-btn" style="display: none;" title="Enter Fullscreen"></button>

        <!-- Mobile Controls -->
        <div id="mobileControls" class="mobile-controls" style="display: none;">
            <!-- D-pad -->
            <div class="mobile-dpad">
                <div class="dpad-center"></div>
                <button class="dpad-btn dpad-up" data-direction="up">‚Üë</button>
                <button class="dpad-btn dpad-down" data-direction="down">‚Üì</button>
                <button class="dpad-btn dpad-left" data-direction="left">‚Üê</button>
                <button class="dpad-btn dpad-right" data-direction="right">‚Üí</button>
                <button class="dpad-btn dpad-up-left" data-direction="upLeft">‚Üñ</button>
                <button class="dpad-btn dpad-up-right" data-direction="upRight">‚Üó</button>
                <button class="dpad-btn dpad-down-left" data-direction="downLeft">‚Üô</button>
                <button class="dpad-btn dpad-down-right" data-direction="downRight">‚Üò</button>
            </div>
            
            <!-- Chat Button -->
            <button id="mobileChatBtn" class="mobile-chat-btn">üí¨</button>
        </div>

        <!-- Pause Menu -->
        <div id="pauseMenu" class="pause-menu">
            <div class="pause-content">
                <div class="pause-title">GAME PAUSED</div>
                <button id="resumeBtn" class="pause-button resume">‚ñ∂ RESUME</button>
                <button id="quitBtn" class="pause-button quit">üè† QUIT TO MENU</button>
            </div>
        </div>

        <!-- Controls Window -->
        <div id="controlsWindow" class="controls-window">
            <div class="controls-content">
                <div class="controls-header">
                    <h3>üéÆ Game Controls</h3>
                    <button class="controls-close" id="controlsClose">‚úñ</button>
                </div>
                <div class="controls-body" id="controlsBody">
                    <!-- Controls will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

        <script type="module">
            // Debug mode disabled for production
            // window.DEBUG_MODE = true;
            import { Game } from './core/Game.js';
            import { SaveSystem } from './core/SaveSystem.js';
            import { World } from './world/World.js';
            import { SecurityUtils } from './utils/SecurityUtils.js';

        // Controls system
        class GameControls {
            constructor() {
                this.isOpen = false;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.populateControls();
            }

            setupEventListeners() {
                // Controls bubble click
                const controlsBubble = document.getElementById('controlsBubble');
                const controlsWindow = document.getElementById('controlsWindow');
                const controlsClose = document.getElementById('controlsClose');

                controlsBubble.addEventListener('click', () => {
                    this.toggleControls();
                });

                controlsClose.addEventListener('click', () => {
                    this.closeControls();
                });

                // Close when clicking outside
                controlsWindow.addEventListener('click', (e) => {
                    if (e.target === controlsWindow) {
                        this.closeControls();
                    }
                });
            }

            populateControls() {
                const controlsBody = document.getElementById('controlsBody');
                const keybinds = this.loadKeybinds();
                
                controlsBody.innerHTML = `
                    <div class="control-category">
                        <h4>üö∂ Movement</h4>
                        ${this.renderControlItem('Move Up', keybinds.moveUp, true)}
                        ${this.renderControlItem('Move Down', keybinds.moveDown, true)}
                        ${this.renderControlItem('Move Left', keybinds.moveLeft, true)}
                        ${this.renderControlItem('Move Right', keybinds.moveRight, true)}
                        ${this.renderControlItem('Sprint', keybinds.sprint, true)}
                        ${this.renderControlItem('Crouch', keybinds.crouch, true)}
                    </div>

                    <div class="control-category">
                        <h4>üéÆ Game Controls</h4>
                        ${this.renderControlItem('Pause Game', keybinds.pause, true)}
                        ${this.renderControlItem('Open Inventory (I)', keybinds.inventory, true)}
                        ${this.renderControlItem('Interact', keybinds.interact, false)}
                        ${this.renderControlItem('Main Menu', keybinds.menu, false)}
                        ${this.renderControlItem('Debug Info', keybinds.debug, true)}
                        ${this.renderControlItem('Screenshot', keybinds.screenshot, true)}
                    </div>

                    <div class="control-category">
                        <h4>üì∑ Camera</h4>
                        ${this.renderControlItem('Mouse Look', 'Mouse', true)}
                        ${this.renderControlItem('Zoom In/Out', 'Scroll Wheel', true)}
                        ${this.renderControlItem('Zoom In', keybinds.zoomIn, false)}
                        ${this.renderControlItem('Zoom Out', keybinds.zoomOut, false)}
                        ${this.renderControlItem('Reset Zoom', keybinds.resetZoom, false)}
                        ${this.renderControlItem('Camera Lock', keybinds.toggleCameraLock, false)}
                    </div>

                    <div class="control-category">
                        <h4>üîä Audio</h4>
                        ${this.renderControlItem('Toggle Audio', keybinds.toggleAudio, true)}
                        ${this.renderControlItem('Volume Up', keybinds.volumeUp, false)}
                        ${this.renderControlItem('Volume Down', keybinds.volumeDown, false)}
                    </div>
                `;
            }

            renderControlItem(action, key, isImplemented) {
                const status = isImplemented ? 'implemented' : 'coming-soon';
                const statusIcon = isImplemented ? '‚úÖ' : 'üöß';
                const keyDisplay = this.formatKeyDisplay(key);
                
                return `
                    <div class="control-item">
                        <span class="control-action">${action}</span>
                        <div style="display: flex; align-items: center;">
                            <span class="control-key">${keyDisplay}</span>
                            <span class="control-status ${status}">${statusIcon}</span>
                        </div>
                    </div>
                `;
            }

            formatKeyDisplay(keyCode) {
                const keyMap = {
                    'KeyW': 'W', 'KeyA': 'A', 'KeyS': 'S', 'KeyD': 'D',
                    'KeyE': 'E', 'KeyF': 'F', 'KeyI': 'I', 'KeyM': 'M',
                    'KeyK': 'K', 'ShiftLeft': 'Shift', 'ControlLeft': 'Ctrl',
                    'Escape': 'ESC', 'Space': 'Space', 'F1': 'F1', 'F12': 'F12',
                    'Equal': '=', 'Minus': '-', 'BracketLeft': '[', 'BracketRight': ']'
                };
                return keyMap[keyCode] || keyCode;
            }

            loadKeybinds() {
                const saved = localStorage.getItem('gameKeybinds');
                if (saved) {
                    try {
                        return JSON.parse(saved);
                    } catch (e) {
                        console.error('Failed to load keybinds:', e);
                    }
                }
                
                // Default keybinds
                return {
                    moveUp: 'KeyW', moveDown: 'KeyS', moveLeft: 'KeyA', moveRight: 'KeyD',
                    sprint: 'ShiftLeft', crouch: 'ControlLeft', pause: 'Escape', inventory: 'KeyI',
                    interact: 'KeyE', menu: 'KeyM', debug: 'F1', screenshot: 'F12',
                    zoomIn: 'Equal', zoomOut: 'Minus', resetZoom: 'Digit0', toggleCameraLock: 'KeyC',
                    toggleAudio: 'KeyK', volumeUp: 'BracketRight', volumeDown: 'BracketLeft'
                };
            }

            toggleControls() {
                if (this.isOpen) {
                    this.closeControls();
                } else {
                    this.openControls();
                }
            }

            openControls() {
                const controlsWindow = document.getElementById('controlsWindow');
                controlsWindow.classList.add('show');
                this.isOpen = true;
            }

            closeControls() {
                const controlsWindow = document.getElementById('controlsWindow');
                controlsWindow.classList.remove('show');
                this.isOpen = false;
            }
        }

        window.addEventListener('load', async () => {
            try {
                // Initialize controls system
                window.gameControls = new GameControls();
                
                let game;
                let worldConfig = null;
                let saveData = null;

                // Parse URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const isNewWorld = urlParams.get('new') === 'true';
                const slotParam = urlParams.get('slot');
                const customWorldParam = urlParams.get('customWorld');
                const isMultiplayer = urlParams.get('multiplayer') === 'true';

                // DEBUG: Log URL parameters immediately
                console.log('üîç DEBUG: URL parameters detected:', {
                    isMultiplayer,
                    customWorldParam,
                    isNewWorld,
                    slotParam,
                    fullURL: window.location.href,
                    searchParams: window.location.search
                });

                if (customWorldParam) {
                    // ‚úÖ SECURITY FIX (VULN-004): Validate URL parameter
                    // Whitelist of allowed worlds
                    const ALLOWED_WORLDS = ['tir-na-nog'];
                    const sanitized = SecurityUtils.validateURLParam(customWorldParam, ALLOWED_WORLDS);
                    
                    if (!sanitized) {
                        console.error('Invalid world parameter:', customWorldParam);
                        alert(`Invalid world name. Allowed worlds: ${ALLOWED_WORLDS.join(', ')}\n\nUsing default world instead.`);
                        game = new Game(null, null);
                    } else {
                        // Load custom world from file with validated parameter
                        const worldPath = `worlds/${sanitized}/world.json`;
                        console.log(`üîç DEBUG: Loading custom world from: ${worldPath}`);
                        
                        const customWorldData = await World.loadFromFile(worldPath);
                        console.log('üîç DEBUG: loadFromFile result:', customWorldData);
                        if (customWorldData) {
                            game = new Game(null, null, customWorldData);
                            console.log(`Custom world "${customWorldData.metadata?.name || 'Unknown'}" loaded successfully!`);
                        } else {
                            console.error('üîç DEBUG: loadFromFile returned null, showing error alert');
                            alert(`Failed to load custom world: ${sanitized}\n\nMake sure you have placed world.json in:\nRunesOfTirNaNog/worlds/${sanitized}/world.json\n\nAnd that the server is running on the correct port.`);
                            game = new Game(null, null);
                        }
                    }
                } else if (isMultiplayer) {
                    // Load custom world for multiplayer
                    console.log('üåç Loading custom world for multiplayer...');
                    try {
                        // Try to load the custom world data from Railway server
                        console.log('üîç Fetching world data from: https://web-production-b1ed.up.railway.app/worlds/world.json');
                        const worldDataResponse = await fetch('https://web-production-b1ed.up.railway.app/worlds/world.json');
                        console.log('üì° Fetch response status:', worldDataResponse.status, worldDataResponse.statusText);
                        console.log('üì° Response headers:', Object.fromEntries(worldDataResponse.headers.entries()));
                        
                        if (worldDataResponse.ok) {
                            const customWorldData = await worldDataResponse.json();
                            console.log('‚úÖ Custom world data loaded successfully:', customWorldData.metadata?.name || 'Tir na n√ìg');
                            console.log('üìè World dimensions:', customWorldData.worldWidth, 'x', customWorldData.worldHeight);
                            console.log('üß± Total tiles:', customWorldData.tiles?.length || 0);
                            console.log('üéÆ Creating game with custom world data...');
                            game = new Game(null, null, customWorldData);
                        } else {
                            console.warn('‚ö†Ô∏è Could not load custom world (HTTP', worldDataResponse.status, '), using default');
                            console.warn('üîÑ Falling back to default world generation');
                            const responseText = await worldDataResponse.text();
                            console.warn('üìÑ Response body:', responseText);
                            game = new Game(null, null);
                        }
                    } catch (error) {
                        console.warn('‚ùå Error loading custom world:', error);
                        console.warn('üîÑ Using default world instead');
                        console.warn('‚ùå Error details:', error.message, error.stack);
                        game = new Game(null, null);
                    }
                } else if (isNewWorld) {
                    // Load world config from sessionStorage
                    const configJson = sessionStorage.getItem('worldConfig');
                    if (configJson) {
                        worldConfig = JSON.parse(configJson);
                        
                        // Prompt for save slot
                        const slot = prompt('Save to slot (1 or 2):');
                        const slotNum = parseInt(slot);
                        if (slotNum === 1 || slotNum === 2) {
                            game = new Game(worldConfig, null);
                            game.saveSlot = slotNum;
                        } else {
                            game = new Game(worldConfig, null);
                        }
                        
                        // Clear session storage
                        sessionStorage.removeItem('worldConfig');
                    } else {
                        game = new Game(null, null);
                    }
                } else if (slotParam) {
                    // Load from save slot
                    const slotNum = parseInt(slotParam);
                    if (slotNum >= 1 && slotNum <= SaveSystem.MAX_SLOTS) {
                        saveData = SaveSystem.loadWorld(slotNum);
                        if (saveData) {
                            game = new Game(null, saveData);
                            game.saveSlot = slotNum;
                        } else {
                            console.error(`No save data found in slot ${slotNum}`);
                            game = new Game(null, null);
                        }
                    } else {
                        console.error('Invalid slot number');
                        game = new Game(null, null);
                    }
                } else {
                    // No parameters, create default world
                    game = new Game(null, null);
                }

                window.game = game;

                // Initialize chat system for multiplayer
                if (isMultiplayer) {
                    initializeChatSystem(game);
                    
                    // Connect to multiplayer server
                    console.log('Multiplayer mode enabled - connecting to server...');
                    game.connectToMultiplayer().then(success => {
                        if (success) {
                            console.log('‚úÖ Successfully connected to multiplayer server');
                        } else {
                            console.error('‚ùå Failed to connect to multiplayer server');
                            console.error('Make sure the WebSocket server is running on wss://web-production-b1ed.up.railway.app/ws');
                        }
                    }).catch(error => {
                        console.error('‚ùå Multiplayer connection error:', error);
                        console.error('Make sure the WebSocket server is running on wss://web-production-b1ed.up.railway.app/ws');
                    });
                }

                // Initialize mobile controls
                initializeMobileControls(game);

                // Make functions globally available for debugging
                window.setPlayerName = (name) => game.setPlayerName(name);
                window.getPlayerName = () => game.getPlayerName();
                window.connectMultiplayer = () => game.connectToMultiplayer();
                window.disconnectMultiplayer = () => game.disconnectFromMultiplayer();
                window.getNetworkStatus = () => {
                    if (game.networkManager) {
                        return {
                            isConnected: game.networkManager.isConnected,
                            socket: game.networkManager.socket?.readyState,
                            playerId: game.networkManager.playerId
                        };
                    }
                    return { error: 'NetworkManager not found' };
                };

                console.log('Runes of Tir na n√ìg - Game initialized successfully');
                console.log('Components loaded:', {
                    Player: '‚úì',
                    Input: '‚úì',
                    World: '‚úì',
                    Camera: '‚úì',
                    UI: '‚úì',
                    GameLoop: '‚úì',
                    NameTag: '‚úì',
                    SaveSystem: '‚úì'
                });
                console.log('Player name:', game.getPlayerName());
                console.log('Try: setPlayerName("Your Name") to change the player name');
            } catch (error) {
                console.error('Failed to initialize game:', error);
            }
        });

        // Pause when window loses focus
        document.addEventListener('visibilitychange', () => {
            if (window.game) {
                if (document.hidden) {
                    window.game.pause();
                } else {
                    window.game.resume();
                }
            }
        });

        // Chat System
        class ChatManager {
            constructor(game) {
                this.game = game;
                this.chatContainer = document.getElementById('chatContainer');
                this.chatMessages = document.getElementById('chatMessages');
                this.chatInput = document.getElementById('chatInput');
                this.chatSend = document.getElementById('chatSend');
                this.isChatOpen = false;
                
                this.setupEventListeners();
                this.setupNetworkCallbacks();
            }
            
            setupEventListeners() {
                // T key to toggle chat
                document.addEventListener('keydown', (e) => {
                    if (e.key.toLowerCase() === 't' && !this.isChatOpen) {
                        e.preventDefault();
                        this.openChat();
                    } else if (e.key === 'Escape' && this.isChatOpen) {
                        e.preventDefault();
                        this.closeChat();
                    }
                });
                
                // Send button click
                this.chatSend.addEventListener('click', () => {
                    this.sendMessage();
                });
                
                // Enter key to send message
                this.chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
            }
            
            setupNetworkCallbacks() {
                if (this.game.networkManager) {
                    this.game.networkManager.onChatMessage = (data) => {
                        this.addMessage(data.username, data.message, 'player');
                    };
                    
                    this.game.networkManager.onChatHistory = (data) => {
                        data.messages.forEach(msg => {
                            this.addMessage(msg.username, msg.message, msg.type || 'player');
                        });
                    };
                }
            }
            
            openChat() {
                this.chatContainer.style.display = 'flex';
                this.chatInput.focus();
                this.isChatOpen = true;
            }
            
            closeChat() {
                this.chatContainer.style.display = 'none';
                this.chatInput.value = '';
                this.isChatOpen = false;
            }
            
            sendMessage() {
                const message = this.chatInput.value.trim();
                if (message && this.game.networkManager) {
                    this.game.networkManager.sendChatMessage(message);
                    this.chatInput.value = '';
                }
            }
            
            addMessage(username, message, type = 'player') {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${type}`;
                
                if (type === 'system') {
                    messageDiv.textContent = message;
                } else {
                    messageDiv.innerHTML = `<span class="username">${username}:</span> ${message}`;
                }
                
                this.chatMessages.appendChild(messageDiv);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
                
                // Keep only last 50 messages
                while (this.chatMessages.children.length > 50) {
                    this.chatMessages.removeChild(this.chatMessages.firstChild);
                }
            }
        }
        
        function initializeChatSystem(game) {
            window.chatManager = new ChatManager(game);
            console.log('Chat system initialized - Press T to open chat');
        }

        // Mobile Controls System
        class MobileControlsManager {
            constructor(game) {
                this.game = game;
                this.mobileControls = document.getElementById('mobileControls');
                this.dpadButtons = document.querySelectorAll('.dpad-btn');
                this.mobileChatBtn = document.getElementById('mobileChatBtn');
                this.fullscreenBtn = document.getElementById('fullscreenBtn');
                this.isFullscreen = false;
                
                this.setupEventListeners();
                this.detectMobileDevice();
            }
            
            setupEventListeners() {
                // D-pad button events
                this.dpadButtons.forEach(btn => {
                    const direction = btn.dataset.direction;
                    
                    // Touch events
                    btn.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        this.handleDpadPress(direction, true);
                    });
                    
                    btn.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        this.handleDpadPress(direction, false);
                    });
                    
                    // Mouse events (for testing on desktop)
                    btn.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        this.handleDpadPress(direction, true);
                    });
                    
                    btn.addEventListener('mouseup', (e) => {
                        e.preventDefault();
                        this.handleDpadPress(direction, false);
                    });
                    
                    // Prevent context menu
                    btn.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                    });
                });
                
                // Mobile chat button
                this.mobileChatBtn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.openMobileChat();
                });
                
                this.mobileChatBtn.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    this.openMobileChat();
                });

                // Fullscreen button events
                this.fullscreenBtn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.toggleFullscreen();
                });
                
                this.fullscreenBtn.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    this.toggleFullscreen();
                });

                // Listen for fullscreen changes
                document.addEventListener('fullscreenchange', () => {
                    this.isFullscreen = !!document.fullscreenElement;
                    this.updateFullscreenButton();
                });

                document.addEventListener('webkitfullscreenchange', () => {
                    this.isFullscreen = !!document.webkitFullscreenElement;
                    this.updateFullscreenButton();
                });

                document.addEventListener('mozfullscreenchange', () => {
                    this.isFullscreen = !!document.mozFullScreenElement;
                    this.updateFullscreenButton();
                });

                document.addEventListener('MSFullscreenChange', () => {
                    this.isFullscreen = !!document.msFullscreenElement;
                    this.updateFullscreenButton();
                });
            }
            
            handleDpadPress(direction, pressed) {
                if (this.game.input) {
                    this.game.input.setMobileDpadState(direction, pressed);
                }
            }
            
            openMobileChat() {
                if (window.chatManager) {
                    window.chatManager.openChat();
                }
            }

            toggleFullscreen() {
                if (!this.isFullscreen) {
                    this.enterFullscreen();
                } else {
                    this.exitFullscreen();
                }
            }

            enterFullscreen() {
                const element = document.documentElement;
                
                if (element.requestFullscreen) {
                    element.requestFullscreen();
                } else if (element.webkitRequestFullscreen) {
                    element.webkitRequestFullscreen();
                } else if (element.mozRequestFullScreen) {
                    element.mozRequestFullScreen();
                } else if (element.msRequestFullscreen) {
                    element.msRequestFullscreen();
                }
            }

            exitFullscreen() {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }

            updateFullscreenButton() {
                if (this.fullscreenBtn) {
                    this.fullscreenBtn.title = this.isFullscreen ? 'Exit Fullscreen' : 'Enter Fullscreen';
                    // Update CSS pseudo-element content
                    this.fullscreenBtn.style.setProperty('--icon', this.isFullscreen ? '"‚õ∂"' : '"‚õ∂"');
                }
            }
            
            detectMobileDevice() {
                // Show mobile controls on touch devices
                if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
                    this.mobileControls.style.display = 'flex';
                    this.fullscreenBtn.style.display = 'flex';
                    console.log('Mobile controls enabled - Touch device detected');
                } else {
                    console.log('Desktop device detected - Mobile controls hidden');
                }
            }
        }
        
        function initializeMobileControls(game) {
            window.mobileControlsManager = new MobileControlsManager(game);
        }
    </script>
</body>
</html>
