<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- ✅ SECURITY FIX (VULN-006): Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: blob:; connect-src 'self' ws://localhost:1234 ws://127.0.0.1:1234; base-uri 'self'; form-action 'self';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Referrer-Policy" content="no-referrer">
    
    <title>The War Room - DCS</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a, #1a0a0a, #0a0a1a, #1a1a0a);
            background-size: 400% 400%;
            animation: aurora 20s ease infinite;
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse at 20% 30%, rgba(255, 50, 50, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 60%, rgba(50, 255, 50, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 80%, rgba(50, 100, 255, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 10% 80%, rgba(255, 150, 0, 0.1) 0%, transparent 40%),
                radial-gradient(ellipse at 90% 20%, rgba(255, 255, 50, 0.1) 0%, transparent 40%);
            animation: shimmer 15s ease-in-out infinite alternate;
            pointer-events: none;
        }

        @keyframes aurora {
            0% { background-position: 0% 50%; }
            25% { background-position: 50% 75%; }
            50% { background-position: 100% 50%; }
            75% { background-position: 50% 25%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes shimmer {
            0% { opacity: 0.5; transform: translateY(0); }
            100% { opacity: 0.8; transform: translateY(-20px); }
        }
        
        /* Header styling */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px 20px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-arrow {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            font-size: 0.9rem;
            font-weight: 500;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 20px;
            box-shadow: 0 4px 16px 0 rgba(31, 38, 135, 0.2);
            text-decoration: none;
            display: inline-block;
        }

        .back-arrow:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(31, 38, 135, 0.3);
        }

        .war-room-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.95);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* Quick Actions Dropdown */
        .quick-actions-dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-toggle {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            font-size: 0.9rem;
            font-weight: 500;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 20px;
            box-shadow: 0 4px 16px 0 rgba(31, 38, 135, 0.2);
            display: inline-block;
        }

        .dropdown-toggle:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(31, 38, 135, 0.3);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 10px;
            min-width: 250px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);
            z-index: 1001;
            display: none;
            flex-direction: column;
            gap: 8px;
        }

        .dropdown-menu.show {
            display: flex;
        }

        .dropdown-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
            padding: 12px 16px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 10px;
            text-align: left;
            width: 100%;
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 1);
            transform: translateX(5px);
        }

        /* Main content */
        .main-content {
            margin-top: 80px;
            padding: 20px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        /* War room grid */
        .war-room-grid {
            display: grid;
            grid-template-columns: auto 1fr auto;
            grid-template-rows: auto auto;
            gap: 20px;
            margin-bottom: 30px;
            align-items: start;
        }

        /* Individual card sizing */
        .war-room-card {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 
                0 8px 32px 0 rgba(0, 0, 0, 0.8),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                0 0 20px rgba(255, 50, 50, 0.1);
            transition: all 0.3s ease;
            position: relative;
        }

        .war-room-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(255, 50, 50, 0.05) 0%, 
                rgba(50, 255, 50, 0.05) 25%, 
                rgba(50, 100, 255, 0.05) 50%, 
                rgba(255, 150, 0, 0.05) 75%, 
                rgba(255, 255, 50, 0.05) 100%);
            border-radius: 15px;
            pointer-events: none;
            opacity: 0.3;
        }

        /* Checklist card - auto-size to content */
        .war-room-card:first-child {
            width: 400px;
            min-width: 350px;
            max-width: 450px;
            height: fit-content;
        }

        /* Notes card - resizable */
        .war-room-card:nth-child(2) {
            min-width: 500px;
            max-width: 800px;
            width: 600px;
            height: auto;
            min-height: 300px;
            max-height: none;
        }

        /* Assets card - auto-size to content */
        .war-room-card:last-child {
            width: 400px;
            min-width: 350px;
            max-width: 450px;
            height: fit-content;
        }

        /* Responsive layout for different screen sizes */
        @media (min-width: 1200px) {
            .war-room-grid {
                grid-template-columns: auto 1fr auto;
                grid-template-rows: auto auto;
            }
            
            .war-room-card:first-child {
                grid-column: 1;
                grid-row: 1;
            }
            
            .war-room-card:nth-child(2) {
                grid-column: 2;
                grid-row: 1 / 3;
            }
            
            .war-room-card:nth-child(3) {
                grid-column: 3;
                grid-row: 1;
                width: 400px;
                min-width: 350px;
                max-width: 500px;
            }
            
            .war-room-card:last-child {
                grid-column: 3;
                grid-row: 2;
                width: 400px;
                min-width: 350px;
                max-width: 500px;
            }
        }

        @media (max-width: 1199px) {
            .war-room-grid {
                grid-template-columns: auto 1fr auto;
                grid-template-rows: auto auto;
            }
            
            .war-room-card:first-child {
                grid-column: 1;
                grid-row: 1;
                width: auto;
                min-width: 300px;
                max-width: none;
            }
            
            .war-room-card:nth-child(2) {
                grid-column: 2;
                grid-row: 1 / 3;
                width: auto;
                min-width: 400px;
                max-width: none;
            }
            
            .war-room-card:nth-child(3) {
                grid-column: 3;
                grid-row: 1;
                width: auto;
                min-width: 300px;
                max-width: none;
            }
            
            .war-room-card:last-child {
                grid-column: 3;
                grid-row: 2;
                width: auto;
                min-width: 300px;
                max-width: none;
            }
        }

        @media (max-width: 768px) {
            .war-room-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto auto;
            }
            
            .war-room-card {
                width: auto !important;
                min-width: auto !important;
                max-width: none !important;
                grid-column: 1 !important;
            }
            
            .war-room-card:first-child {
                grid-row: 1;
            }
            
            .war-room-card:nth-child(2) {
                grid-row: 2;
            }
            
            .war-room-card:nth-child(3) {
                grid-row: 3;
            }
            
            .war-room-card:last-child {
                grid-row: 4;
            }
        }

        /* Card styling - removed duplicate */

        .war-room-card:hover {
            transform: translateY(-5px);
            box-shadow: 
                0 12px 40px 0 rgba(0, 0, 0, 0.9),
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                0 0 30px rgba(255, 50, 50, 0.3);
            border-color: rgba(255, 50, 50, 0.3);
        }

        .war-room-card:hover::before {
            opacity: 0.5;
        }

        .card-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-shadow: 0 0 10px rgba(255, 50, 50, 0.5);
            position: relative;
            z-index: 1;
            text-align: center;
        }

        /* Checklist section */
        .checklist-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            transition: all 0.3s ease;
        }

        .checklist-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding-left: 8px;
            padding-right: 8px;
        }

        .checklist-item:last-child {
            border-bottom: none;
        }

        .delete-task-btn {
            background: linear-gradient(135deg, rgba(255, 50, 50, 0.8), rgba(150, 0, 0, 0.9));
            border: 2px solid rgba(255, 50, 50, 1);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            opacity: 0;
            margin-left: auto;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
            box-shadow: 0 4px 15px rgba(255, 50, 50, 0.3);
        }

        .checklist-item:hover .delete-task-btn {
            opacity: 1;
        }

        .delete-task-btn:hover {
            background: linear-gradient(135deg, rgba(255, 50, 50, 1), rgba(150, 0, 0, 1));
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 50, 50, 0.5);
        }

        .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            background: rgba(0, 0, 0, 0.5);
        }

        .checkbox.checked {
            background: linear-gradient(135deg, #50ff50, #00aa00);
            border-color: #50ff50;
            box-shadow: 0 0 10px rgba(50, 255, 50, 0.5);
        }

        .checkbox.checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 12px;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
        }

        .checklist-text {
            flex: 1;
            color: rgba(255, 255, 255, 0.9);
        }

        .checklist-text.completed {
            text-decoration: line-through;
            opacity: 0.6;
        }

        /* Add item form */
        .add-item-form {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .add-item-input {
            flex: 1;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.95);
            padding: 10px 15px;
            border-radius: 12px;
            font-family: inherit;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        .add-item-input:focus {
            outline: none;
            border-color: rgba(50, 255, 50, 0.6);
            background: rgba(0, 0, 0, 0.8);
            box-shadow: 
                inset 0 2px 5px rgba(0, 0, 0, 0.5),
                0 0 10px rgba(50, 255, 50, 0.3);
        }

        .add-item-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .add-btn {
            background: linear-gradient(135deg, rgba(50, 255, 50, 0.8), rgba(0, 150, 0, 0.9));
            border: 2px solid rgba(50, 255, 50, 1);
            color: white;
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
            box-shadow: 0 4px 15px rgba(50, 255, 50, 0.3);
        }

        .add-btn:hover {
            background: linear-gradient(135deg, rgba(50, 255, 50, 1), rgba(0, 150, 0, 1));
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(50, 255, 50, 0.5);
        }

        /* Notes section */
        .new-note-btn {
            background: linear-gradient(135deg, rgba(255, 150, 0, 0.8), rgba(200, 100, 0, 0.9));
            border: 2px solid rgba(255, 150, 0, 1);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            float: right;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
            box-shadow: 0 4px 15px rgba(255, 150, 0, 0.3);
        }

        .new-note-btn:hover {
            background: linear-gradient(135deg, rgba(255, 150, 0, 1), rgba(200, 100, 0, 1));
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 150, 0, 0.5);
        }

        .notes-list {
            margin-bottom: 20px;
        }

        .note-item {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .note-item:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        .note-item.active {
            background: rgba(64, 164, 255, 0.2);
            border-color: rgba(64, 164, 255, 0.5);
        }

        .note-title {
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 4px;
        }

        .note-preview {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.3;
        }

        .note-actions {
            display: flex;
            gap: 8px;
        }

        .note-delete-btn {
            background: rgba(255, 107, 107, 0.8);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .note-delete-btn:hover {
            background: rgba(255, 107, 107, 1);
            transform: scale(1.1);
        }

        /* Note Editor */
        .note-editor {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 0;
            overflow: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .editor-toolbar {
            background: rgba(255, 255, 255, 0.08);
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            padding: 12px;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.9);
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            min-width: 32px;
            text-align: center;
        }

        .toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .toolbar-separator {
            width: 1px;
            height: 20px;
            background: rgba(255, 255, 255, 0.3);
            margin: 0 4px;
        }

        .note-title-input {
            width: 100%;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.95);
            padding: 16px;
            font-size: 1.2rem;
            font-weight: 600;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        }

        .note-title-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .note-title-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.05);
        }

        .note-content-editor {
            flex: 1;
            min-height: 200px;
            padding: 16px;
            color: rgba(255, 255, 255, 0.95);
            font-family: inherit;
            line-height: 1.6;
            overflow-y: auto;
            margin: 0;
        }

        .note-content-editor:focus {
            outline: none;
        }

        .note-content-editor:empty:before {
            content: attr(placeholder);
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
        }

        .note-section {
            margin-bottom: 20px;
        }

        .note-section h3 {
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .note-section ul {
            margin-left: 20px;
        }

        .note-section li {
            margin-bottom: 4px;
            color: rgba(255, 255, 255, 0.85);
        }

        .note-content-editor b {
            font-weight: bold;
        }

        .note-content-editor i {
            font-style: italic;
        }

        .note-content-editor u {
            text-decoration: underline;
        }

        /* Notes section responsive styling */
        .war-room-card:has(.notes-list) {
            min-height: 500px;
            max-height: 800px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .notes-list {
            flex-shrink: 0;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .note-editor {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 300px;
            margin: 0;
        }

        .note-content-editor {
            flex: 1;
            min-height: 200px;
            max-height: none;
            margin: 0;
        }

        /* Responsive notes layout */
        @media (max-width: 768px) {
            .war-room-card:has(.notes-list) {
                min-height: 400px;
                max-height: 600px;
            }
            
            .note-content-editor {
                min-height: 150px;
                max-height: none;
            }
            
            .notes-list {
                max-height: 150px;
            }
        }

        /* Size reload button */
        .size-reload-btn {
            background: linear-gradient(135deg, rgba(50, 100, 255, 0.8), rgba(0, 50, 150, 0.9));
            border: 2px solid rgba(50, 100, 255, 1);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-left: 8px;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
            box-shadow: 0 4px 15px rgba(50, 100, 255, 0.3);
        }

        .size-reload-btn:hover {
            background: linear-gradient(135deg, rgba(50, 100, 255, 1), rgba(0, 50, 150, 1));
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(50, 100, 255, 0.5);
        }

        /* Collapse button */
        .collapse-btn {
            background: linear-gradient(135deg, rgba(255, 255, 50, 0.8), rgba(200, 200, 0, 0.9));
            border: 2px solid rgba(255, 255, 50, 1);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-left: auto;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
            box-shadow: 0 4px 15px rgba(255, 255, 50, 0.3);
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .collapse-btn:hover {
            background: linear-gradient(135deg, rgba(255, 255, 50, 1), rgba(200, 200, 0, 1));
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(255, 255, 50, 0.5);
        }

        .collapse-btn.collapsed {
            background: linear-gradient(135deg, rgba(255, 255, 50, 0.6), rgba(200, 200, 0, 0.7));
        }

        .collapse-btn.collapsed:hover {
            background: linear-gradient(135deg, rgba(255, 255, 50, 0.8), rgba(200, 200, 0, 0.9));
        }

        /* Quick actions content */
        .quick-actions-content {
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .quick-actions-content.collapsed {
            max-height: 0;
            padding: 0;
            margin: 0;
            opacity: 0;
        }

        /* Resizable functionality */
        .resizable-card {
            position: relative;
            transition: none !important;
        }

        .resizer-handle {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 20px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            cursor: ns-resize;
            border-radius: 0 0 15px 15px;
            transition: all 0.3s ease;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .resizer-handle::before {
            content: '';
            width: 40px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .resizer-handle:hover {
            background: linear-gradient(90deg, transparent, rgba(64, 164, 255, 0.4), transparent);
            height: 24px;
        }

        .resizer-handle:hover::before {
            background: rgba(64, 164, 255, 0.8);
            width: 50px;
            height: 6px;
        }

        .resizer-handle:active {
            background: linear-gradient(90deg, transparent, rgba(64, 164, 255, 0.5), transparent);
        }

        .resizer-handle:active::before {
            background: rgba(64, 164, 255, 1);
        }

        /* Resizing state */
        .resizing {
            user-select: none;
            pointer-events: none;
        }

        .resizing .resizer-handle {
            background: linear-gradient(90deg, transparent, rgba(64, 164, 255, 0.8), transparent);
        }

        /* Resizer handle visibility */
        .resizer-handle {
            opacity: 0.8;
        }

        .resizable-card:hover .resizer-handle {
            opacity: 1;
        }

        .resizer-handle:hover {
            opacity: 1 !important;
        }

        /* Improve grab area reliability */
        .resizer-handle * {
            pointer-events: none;
        }

        .resizer-handle {
            pointer-events: all;
            user-select: none;
        }

        /* Resizer tooltip */
        .resizer-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            margin-bottom: 8px;
            z-index: 1001;
        }

        .resizer-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.8);
        }

        .resizer-handle:hover .resizer-tooltip {
            opacity: 1;
        }

        /* Image upload section */
        .image-upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .image-upload-area:hover {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.05);
        }

        .image-upload-area.dragover {
            border-color: #51cf66;
            background: rgba(81, 207, 102, 0.1);
        }

        .upload-text {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.9rem;
        }

        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
            gap: 15px;
            margin-top: 20px;
            max-width: 100%;
        }

        /* Music panel styles */
        .music-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
            max-width: 100%;
        }

        .music-item {
            background: rgba(20, 20, 20, 0.9);
            border: 2px solid rgba(255, 150, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
            position: relative;
        }

        .music-item:hover {
            border-color: rgba(255, 150, 0, 0.6);
            box-shadow: 0 0 15px rgba(255, 150, 0, 0.2);
            transform: translateY(-2px);
        }

        .music-item audio {
            width: 100%;
            margin-bottom: 10px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 5px;
        }

        .music-item .music-info {
            color: #fff;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .music-item .music-name {
            font-weight: bold;
            color: #ff9600;
            margin-bottom: 5px;
            text-shadow: 0 0 5px rgba(255, 150, 0, 0.5);
        }

        .music-item .music-size {
            color: #888;
            font-size: 12px;
        }

        .music-item .music-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .music-item .music-btn {
            background: linear-gradient(135deg, #ff9600, #ff7700);
            border: 2px solid rgba(255, 150, 0, 0.5);
            color: #000;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-shadow: none;
            box-shadow: 0 2px 8px rgba(255, 150, 0, 0.3);
        }

        .music-item .music-btn:hover {
            background: linear-gradient(135deg, #ff7700, #ff5500);
            border-color: rgba(255, 150, 0, 0.8);
            box-shadow: 0 4px 12px rgba(255, 150, 0, 0.5);
            transform: translateY(-1px);
        }

        .music-item .delete-btn {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            border: 2px solid rgba(255, 68, 68, 0.5);
            color: #fff;
            text-shadow: 0 0 5px rgba(255, 68, 68, 0.8);
        }

        .music-item .delete-btn:hover {
            background: linear-gradient(135deg, #cc0000, #990000);
            border-color: rgba(255, 68, 68, 0.8);
            box-shadow: 0 4px 12px rgba(255, 68, 68, 0.5);
        }

        /* Responsive grid for different screen sizes */
        @media (min-width: 600px) {
            .image-gallery {
                grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            }
            .music-gallery {
                grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            }
        }

        @media (min-width: 900px) {
            .image-gallery {
                grid-template-columns: repeat(3, 1fr);
                max-width: 1350px;
            }
            .music-gallery {
                grid-template-columns: repeat(2, 1fr);
                max-width: 700px;
            }
        }

        /* Ensure maximum 3 columns on larger screens */
        @media (min-width: 1200px) {
            .image-gallery {
                grid-template-columns: repeat(3, 1fr);
                max-width: 1350px;
            }
            .music-gallery {
                grid-template-columns: repeat(2, 1fr);
                max-width: 700px;
            }
        }

        .image-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.1);
        }

        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(239, 68, 68, 0.8);
            border: none;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-item .download-btn {
            position: absolute;
            top: 5px;
            right: 35px;
            background: rgba(81, 207, 102, 0.8);
            border: none;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .image-item .download-btn:hover {
            background: rgba(81, 207, 102, 1);
            transform: scale(1.1);
        }

        /* Progress section */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #51cf66, #40a4ff);
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .progress-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            text-align: center;
        }

        /* Hidden file input */
        .hidden-input {
            display: none;
        }

        /* Image Viewer Modal */
        .image-viewer-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .image-viewer-modal.show {
            display: flex;
            opacity: 1;
        }

        .image-viewer-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .image-viewer-image {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            transition: transform 0.3s ease;
        }

        .image-viewer-image:hover {
            transform: scale(1.05);
        }

        .image-viewer-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .image-viewer-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .image-viewer-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            color: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
        }

        .image-viewer-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 107, 107, 0.9);
            border: 2px solid rgba(255, 107, 107, 1);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-viewer-close:hover {
            background: rgba(255, 107, 107, 1);
            transform: scale(1.1);
        }

        .image-viewer-title {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.2rem;
            font-weight: 500;
            text-align: center;
            max-width: 80%;
            word-wrap: break-word;
        }

        .image-viewer-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.9);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .image-viewer-nav:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-50%) scale(1.1);
        }

        .image-viewer-nav.prev {
            left: 20px;
        }

        .image-viewer-nav.next {
            right: 20px;
        }

        .image-viewer-nav.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="admin.html" class="back-arrow">← Back to Admin</a>
        <div class="quick-actions-dropdown">
            <button class="dropdown-toggle" onclick="toggleQuickActionsDropdown()">⚡ Quick Actions</button>
            <div class="dropdown-menu" id="quickActionsDropdown">
                <button class="dropdown-item" onclick="exportData()">📤 Export War Room Data</button>
                <button class="dropdown-item" onclick="clearCompleted()">🧹 Clear Completed Tasks</button>
                <button class="dropdown-item" onclick="clearNotesCache()">🗑️ Clear Notes Cache</button>
                <button class="dropdown-item" onclick="saveToLocal()">💾 Save to Local Storage</button>
                <button class="dropdown-item" onclick="loadFromLocal()">📥 Load from Local Storage</button>
            </div>
        </div>
        <div class="war-room-title">⚔️ The War Room</div>
        <div></div>
    </div>

    <div class="main-content">
        <div class="war-room-grid">
            <!-- Game Development Checklist -->
            <div class="war-room-card">
                <div class="card-title">
                    📋 Game Development Checklist
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="checklistProgress" style="width: 0%;"></div>
                </div>
                <div class="progress-text" id="progressText">0 of 0 tasks completed</div>
                
                <div id="checklistContainer">
                    <!-- Checklist items will be loaded from server -->
                </div>

                <div class="add-item-form">
                    <input type="text" class="add-item-input" placeholder="Add new task..." id="newTaskInput">
                    <button class="add-btn" onclick="addTask()">Add</button>
                </div>
            </div>

            <!-- Team Notes -->
            <div class="war-room-card resizable-card" id="teamNotesCard">
                <div class="card-title">
                    📝 Team Notes & Ideas
                    <div style="display: flex; gap: 8px;">
                        <button class="size-reload-btn" onclick="reloadNoteSizes()" title="Reload note box sizes">🔄 Reload Sizes</button>
                        <button class="new-note-btn" onclick="createNewNote()">+ New Note</button>
                    </div>
                </div>
                
                <!-- Notes List -->
                <div class="notes-list" id="notesList">
                    <div class="note-item active" data-note-id="note-1">
                        <div class="note-title">🎮 Game Development Notes</div>
                        <div class="note-preview">Current priorities, ideas, bugs to fix...</div>
                        <div class="note-actions">
                            <button class="note-delete-btn" onclick="deleteNote('note-1')">🗑️</button>
                        </div>
                    </div>
                </div>
                
                <!-- Note Editor -->
                <div class="note-editor" id="noteEditor">
                    <div class="editor-toolbar">
                        <button class="toolbar-btn" onclick="formatText('bold')" title="Bold"><b>B</b></button>
                        <button class="toolbar-btn" onclick="formatText('italic')" title="Italic"><i>I</i></button>
                        <button class="toolbar-btn" onclick="formatText('underline')" title="Underline"><u>U</u></button>
                        <button class="toolbar-btn" onclick="insertBulletList()" title="Bullet List">•</button>
                        <button class="toolbar-btn" onclick="insertNumberList()" title="Number List">1.</button>
                        <div class="toolbar-separator"></div>
                        <button class="toolbar-btn" onclick="insertEmoji('🎮')" title="Game">🎮</button>
                        <button class="toolbar-btn" onclick="insertEmoji('💡')" title="Idea">💡</button>
                        <button class="toolbar-btn" onclick="insertEmoji('🐛')" title="Bug">🐛</button>
                        <button class="toolbar-btn" onclick="insertEmoji('✅')" title="Check">✅</button>
                    </div>
                    
                    <input type="text" class="note-title-input" placeholder="Note title..." id="noteTitleInput">
                    
                    <div class="note-content-editor" contenteditable="true" id="noteContentEditor" placeholder="Add your ideas, notes, and thoughts here...">
                    </div>
                </div>
                
                <!-- Resizer Handle -->
                <div class="resizer-handle" id="notesResizerHandle" title="Drag to resize notes box">
                    <span class="resizer-tooltip">Drag to resize</span>
                </div>
            </div>

            <!-- Asset Gallery -->
            <div class="war-room-card">
                <div class="card-title">
                    🖼️ Asset Gallery
                </div>
                <div class="image-upload-area" onclick="document.getElementById('imageInput').click()" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <div class="upload-text">📁 Drop images here or click to upload</div>
                    <div class="upload-hint">PNG, JPG, GIF up to 10MB each</div>
                </div>
                <input type="file" id="imageInput" class="hidden-input" multiple accept="image/*" onchange="handleImageUpload(event)">
                
                <div class="image-gallery" id="imageGallery">
                    <div class="image-item">
                        <img src="dcs.png" alt="DCS Logo" onclick="openImageViewer('dcs.png', 'DCS Logo')" style="cursor: pointer;">
                        <button class="remove-btn" onclick="removeImage(this)">×</button>
                    </div>
                </div>
            </div>

            <!-- Music & Sound Library -->
            <div class="war-room-card">
                <div class="card-title">
                    🎵 Music & Sound Library
                </div>
                <div class="image-upload-area" onclick="document.getElementById('musicInput').click()" ondrop="handleMusicDrop(event)" ondragover="handleMusicDragOver(event)" ondragleave="handleMusicDragLeave(event)">
                    <div class="upload-text">🎶 Drop audio files here or click to upload</div>
                    <div class="upload-hint">MP3, WAV, OGG up to 50MB each</div>
                </div>
                <input type="file" id="musicInput" class="hidden-input" multiple accept="audio/*" onchange="handleMusicUpload(event)">
                
                <div class="music-gallery" id="musicGallery">
                    <!-- Music items will be loaded here -->
                </div>
            </div>

        </div>
    </div>

    <!-- Image Viewer Modal -->
    <div class="image-viewer-modal" id="imageViewerModal">
        <div class="image-viewer-content">
            <button class="image-viewer-close" onclick="closeImageViewer()">×</button>
            <button class="image-viewer-nav prev" onclick="previousImage()" id="prevBtn">‹</button>
            <button class="image-viewer-nav next" onclick="nextImage()" id="nextBtn">›</button>
            
            <img class="image-viewer-image" id="viewerImage" src="" alt="">
            <div class="image-viewer-title" id="viewerTitle"></div>
            
            <div class="image-viewer-controls">
                <button class="image-viewer-btn" onclick="downloadCurrentImage()">📥 Download</button>
                <button class="image-viewer-btn" onclick="deleteCurrentImage()">🗑️ Delete</button>
            </div>
        </div>
    </div>

    <script>
        // Checklist functionality
        async function toggleCheckbox(checkbox) {
            const taskItem = checkbox.closest('.checklist-item');
            const taskText = taskItem.querySelector('.checklist-text').textContent;
            const isCompleted = checkbox.classList.contains('checked');
            
            // Toggle the checkbox
            checkbox.classList.toggle('checked');
            const text = checkbox.nextElementSibling;
            text.classList.toggle('completed');
            
            // Update progress immediately
            updateProgress();
            
            // Save to localStorage immediately for instant persistence
            const currentChecklist = getCurrentChecklist();
            saveChecklistToLocalStorage(currentChecklist);
            
            try {
                const response = await fetch('/api/war-room/checklist', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: taskText,
                        completed: !isCompleted
                    })
                });
                
                if (!response.ok) {
                    console.error('Failed to update task on server');
                    // Revert the checkbox state
                    checkbox.classList.toggle('checked');
                    text.classList.toggle('completed');
                    updateProgress();
                    // Revert localStorage
                    const revertedChecklist = getCurrentChecklist();
                    saveChecklistToLocalStorage(revertedChecklist);
                }
            } catch (error) {
                console.error('Error updating task:', error);
                // Revert the checkbox state
                checkbox.classList.toggle('checked');
                text.classList.toggle('completed');
                updateProgress();
                // Revert localStorage
                const revertedChecklist = getCurrentChecklist();
                saveChecklistToLocalStorage(revertedChecklist);
            }
        }

        async function addTask() {
            const input = document.getElementById('newTaskInput');
            const text = input.value.trim();
            if (text) {
                try {
                    const response = await fetch('/api/war-room/checklist', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            text: text,
                            completed: false
                        })
                    });
                    
                    if (response.ok) {
                        // Reload the checklist from server (which will also update localStorage)
                        await loadChecklist();
                        input.value = '';
                    } else {
                        console.error('Failed to add task to server');
                    }
                } catch (error) {
                    console.error('Error adding task:', error);
                }
            }
        }

        async function deleteTask(button) {
            const taskItem = button.closest('.checklist-item');
            const taskText = taskItem.querySelector('.checklist-text').textContent;
            
            // Simple confirmation prompt
            if (confirm(`Are you sure you want to delete "${taskText}"?`)) {
                try {
                    const response = await fetch('/api/war-room/checklist', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            text: taskText
                        })
                    });
                    
                    if (response.ok) {
                        // Reload the checklist from server (which will also update localStorage)
                        await loadChecklist();
                    } else {
                        console.error('Failed to delete task from server');
                    }
                } catch (error) {
                    console.error('Error deleting task:', error);
                }
            }
        }

        function updateProgress() {
            const checkboxes = document.querySelectorAll('.checkbox');
            const checkedBoxes = document.querySelectorAll('.checkbox.checked');
            const progress = (checkedBoxes.length / checkboxes.length) * 100;
            
            document.getElementById('checklistProgress').style.width = progress + '%';
            document.getElementById('progressText').textContent = 
                `${checkedBoxes.length} of ${checkboxes.length} tasks completed`;
        }

        // Image upload functionality with filesystem storage
        function handleImageUpload(event) {
            const files = event.target.files;
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    uploadImageToServer(file);
                }
            }
        }

        function handleDrop(event) {
            event.preventDefault();
            const uploadArea = event.currentTarget;
            uploadArea.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    uploadImageToServer(file);
                }
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        async function uploadImageToServer(file) {
            const formData = new FormData();
            formData.append('image', file);
            formData.append('warRoomId', 'default'); // You can customize this per project
            
            try {
                const response = await fetch('/api/war-room/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    addImageToGallery(result.filename, result.originalName);
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Failed to upload image. Please try again.');
            }
        }

        function addImageToGallery(filename, originalName) {
            const gallery = document.getElementById('imageGallery');
            const newItem = document.createElement('div');
            newItem.className = 'image-item';
            newItem.innerHTML = `
                <img src="/api/war-room/image/${filename}" alt="${originalName}" loading="lazy" onclick="openImageViewer('${filename}', '${originalName}')" style="cursor: pointer;">
                <button class="remove-btn" onclick="removeImage('${filename}', this)">×</button>
                <button class="download-btn" onclick="downloadImage('${filename}', '${originalName}')" title="Download full quality">⬇️</button>
            `;
            gallery.appendChild(newItem);
        }

        async function removeImage(filename, button) {
            if (confirm('Are you sure you want to delete this image?')) {
                try {
                    const response = await fetch(`/api/war-room/delete-image/${filename}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        button.parentElement.remove();
                    } else {
                        throw new Error('Delete failed');
                    }
                } catch (error) {
                    console.error('Delete error:', error);
                    alert('Failed to delete image. Please try again.');
                }
            }
        }

        async function downloadImage(filename, originalName) {
            try {
                const response = await fetch(`/api/war-room/download-image/${filename}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = originalName;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    throw new Error('Download failed');
                }
            } catch (error) {
                console.error('Download error:', error);
                alert('Failed to download image. Please try again.');
            }
        }

        // Music upload functionality
        function handleMusicUpload(event) {
            const files = event.target.files;
            for (let file of files) {
                if (file.type.startsWith('audio/')) {
                    uploadMusicToServer(file);
                }
            }
        }

        function handleMusicDrop(event) {
            event.preventDefault();
            const uploadArea = event.currentTarget;
            uploadArea.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            for (let file of files) {
                if (file.type.startsWith('audio/')) {
                    uploadMusicToServer(file);
                }
            }
        }

        function handleMusicDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleMusicDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        async function uploadMusicToServer(file) {
            const formData = new FormData();
            formData.append('music', file);
            formData.append('warRoomId', 'default');
            
            try {
                const response = await fetch('/api/war-room/upload-music', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    addMusicToGallery(result.filename, result.originalName, result.size);
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Failed to upload music file. Please try again.');
            }
        }

        function addMusicToGallery(filename, originalName, size) {
            const gallery = document.getElementById('musicGallery');
            const newItem = document.createElement('div');
            newItem.className = 'music-item';
            newItem.innerHTML = `
                <audio controls>
                    <source src="/api/war-room/music/${filename}" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>
                <div class="music-info">
                    <div class="music-name">${originalName}</div>
                    <div class="music-size">${formatFileSize(size)}</div>
                </div>
                <div class="music-actions">
                    <button class="music-btn" onclick="downloadMusic('${filename}', '${originalName}')">📥 Download</button>
                    <button class="music-btn delete-btn" onclick="removeMusic('${filename}', this)">🗑️ Delete</button>
                </div>
            `;
            gallery.appendChild(newItem);
        }

        async function removeMusic(filename, button) {
            if (confirm('Are you sure you want to delete this music file?')) {
                try {
                    const response = await fetch(`/api/war-room/delete-music/${filename}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        button.closest('.music-item').remove();
                    } else {
                        throw new Error('Delete failed');
                    }
                } catch (error) {
                    console.error('Delete error:', error);
                    alert('Failed to delete music file. Please try again.');
                }
            }
        }

        async function downloadMusic(filename, originalName) {
            try {
                const response = await fetch(`/api/war-room/download-music/${filename}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = originalName;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    throw new Error('Download failed');
                }
            } catch (error) {
                console.error('Download error:', error);
                alert('Failed to download music file. Please try again.');
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Load existing music from server
        async function loadExistingMusic() {
            try {
                const response = await fetch('/api/war-room/music');
                if (response.ok) {
                    const musicList = await response.json();
                    const gallery = document.getElementById('musicGallery');
                    gallery.innerHTML = '';
                    
                    musicList.forEach(music => {
                        addMusicToGallery(music.filename, music.originalName || music.filename, music.size);
                    });
                }
            } catch (error) {
                console.error('Error loading music:', error);
            }
        }

        // Quick actions
        function exportData() {
            const data = {
                checklist: Array.from(document.querySelectorAll('.checklist-item')).map(item => ({
                    text: item.querySelector('.checklist-text').textContent,
                    completed: item.querySelector('.checkbox').classList.contains('checked')
                })),
                notes: document.getElementById('teamNotes').value
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'war-room-data.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        async function clearCompleted() {
            const completedItems = document.querySelectorAll('.checklist-item .checkbox.checked');
            completedItems.forEach(checkbox => {
                checkbox.parentElement.remove();
            });
            updateProgress();
            
            // Save to localStorage immediately
            const currentChecklist = getCurrentChecklist();
            saveChecklistToLocalStorage(currentChecklist);
            
            // Sync with server
            try {
                const response = await fetch('/api/war-room/checklist/clear-completed', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    console.log('Cleared completed tasks on server');
                } else {
                    console.error('Failed to clear completed tasks on server');
                }
            } catch (error) {
                console.error('Error clearing completed tasks:', error);
            }
        }


        // Load existing assets from server
        async function loadExistingAssets() {
            try {
                const response = await fetch('/api/war-room/images');
                if (response.ok) {
                    const assets = await response.json();
                    
                    // Clear existing gallery
                    const gallery = document.getElementById('imageGallery');
                    if (gallery) {
                        gallery.innerHTML = '';
                        
                        // Add each asset to the gallery
                        assets.forEach(asset => {
                            // Use filename as originalName if originalName is not available
                            const originalName = asset.originalName || asset.filename || 'Asset';
                            addImageToGallery(asset.filename, originalName);
                        });
                        
                        console.log(`Loaded ${assets.length} existing assets`);
                    }
                } else {
                    console.log('No existing assets found or server not available');
                }
            } catch (error) {
                console.log('Could not load existing assets:', error);
                // This is normal if the server isn't running
            }
        }

        // Quick Actions dropdown functionality
        function toggleQuickActionsDropdown() {
            const dropdown = document.getElementById('quickActionsDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('quickActionsDropdown');
            const toggle = document.querySelector('.dropdown-toggle');
            
            if (!dropdown.contains(event.target) && !toggle.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Clear notes cache function
        function clearNotesCache() {
            if (confirm('Are you sure you want to clear all cached notes? This will reload fresh notes from the server.')) {
                // Clear localStorage cache
                localStorage.removeItem('warRoomNotes');
                localStorage.removeItem('warRoomCurrentNoteId');
                
                // Clear global variables
                window.notes = {};
                window.currentNoteId = 'note-1';
                window.notesLoaded = false;
                
                // Reset current variables
                notes = {};
                currentNoteId = 'note-1';
                
                // Reload the page to get fresh notes from server
                location.reload();
            }
        }

        // Image Viewer functionality
        let currentImageIndex = 0;
        let imageList = [];

        function openImageViewer(filename, originalName) {
            // Build list of all images in the gallery
            imageList = [];
            const gallery = document.getElementById('imageGallery');
            const images = gallery.querySelectorAll('img');
            
            images.forEach((img, index) => {
                const imgSrc = img.src;
                const imgAlt = img.alt;
                imageList.push({
                    src: imgSrc,
                    alt: imgAlt,
                    filename: imgSrc.split('/').pop(),
                    originalName: imgAlt
                });
                
                // Find current image index
                if (img.src.includes(filename)) {
                    currentImageIndex = index;
                }
            });
            
            // Show the modal
            const modal = document.getElementById('imageViewerModal');
            const viewerImage = document.getElementById('viewerImage');
            const viewerTitle = document.getElementById('viewerTitle');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            viewerImage.src = `/api/war-room/image/${filename}`;
            viewerTitle.textContent = originalName;
            
            // Update navigation buttons
            prevBtn.classList.toggle('hidden', imageList.length <= 1);
            nextBtn.classList.toggle('hidden', imageList.length <= 1);
            
            modal.classList.add('show');
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }

        function closeImageViewer() {
            const modal = document.getElementById('imageViewerModal');
            modal.classList.remove('show');
            
            // Restore body scroll
            document.body.style.overflow = '';
        }

        function previousImage() {
            if (imageList.length <= 1) return;
            
            currentImageIndex = (currentImageIndex - 1 + imageList.length) % imageList.length;
            const currentImage = imageList[currentImageIndex];
            
            const viewerImage = document.getElementById('viewerImage');
            const viewerTitle = document.getElementById('viewerTitle');
            
            viewerImage.src = currentImage.src;
            viewerTitle.textContent = currentImage.originalName;
        }

        function nextImage() {
            if (imageList.length <= 1) return;
            
            currentImageIndex = (currentImageIndex + 1) % imageList.length;
            const currentImage = imageList[currentImageIndex];
            
            const viewerImage = document.getElementById('viewerImage');
            const viewerTitle = document.getElementById('viewerTitle');
            
            viewerImage.src = currentImage.src;
            viewerTitle.textContent = currentImage.originalName;
        }

        function downloadCurrentImage() {
            const currentImage = imageList[currentImageIndex];
            if (currentImage) {
                downloadImage(currentImage.filename, currentImage.originalName);
            }
        }

        function deleteCurrentImage() {
            const currentImage = imageList[currentImageIndex];
            if (currentImage && confirm('Are you sure you want to delete this image?')) {
                removeImage(currentImage.filename, null);
                closeImageViewer();
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('imageViewerModal');
            if (event.target === modal) {
                closeImageViewer();
            }
        });

        // Keyboard navigation
        document.addEventListener('keydown', function(event) {
            const modal = document.getElementById('imageViewerModal');
            if (!modal.classList.contains('show')) return;
            
            switch(event.key) {
                case 'Escape':
                    closeImageViewer();
                    break;
                case 'ArrowLeft':
                    previousImage();
                    break;
                case 'ArrowRight':
                    nextImage();
                    break;
            }
        });

        // Load checklist from server
        async function loadChecklist() {
            const container = document.getElementById('checklistContainer');
            
            try {
                const response = await fetch('/api/war-room/checklist');
                if (response.ok) {
                    const checklist = await response.json();
                    
                    // Only update DOM if the data is different from what's currently shown
                    const currentChecklist = getCurrentChecklist();
                    const isDifferent = JSON.stringify(checklist) !== JSON.stringify(currentChecklist);
                    
                    if (isDifferent || container.children.length === 0) {
                        container.innerHTML = '';
                        
                        checklist.forEach(item => {
                            const checklistItem = document.createElement('div');
                            checklistItem.className = 'checklist-item';
                            checklistItem.innerHTML = `
                                <div class="checkbox ${item.completed ? 'checked' : ''}" onclick="toggleCheckbox(this)"></div>
                                <div class="checklist-text ${item.completed ? 'completed' : ''}">${item.text}</div>
                                <button class="delete-task-btn" onclick="deleteTask(this)" title="Delete task">×</button>
                            `;
                            container.appendChild(checklistItem);
                        });
                    }
                    
                    // Save to localStorage for instant loading next time
                    saveChecklistToLocalStorage(checklist);
                    
                    console.log(`Loaded ${checklist.length} checklist items from server`);
                } else {
                    console.log('No checklist data found on server');
                    // Don't clear if we already have items from localStorage
                    if (container.children.length === 0) {
                        container.innerHTML = '';
                    }
                }
            } catch (error) {
                console.log('Could not load checklist from server:', error);
                // Don't clear if we already have items from localStorage
                if (container.children.length === 0) {
                    container.innerHTML = '';
                }
            }
            
            updateProgress();
        }

        // Helper function to save checklist to localStorage
        function saveChecklistToLocalStorage(checklist) {
            try {
                localStorage.setItem('warRoomChecklist', JSON.stringify(checklist));
            } catch (error) {
                console.error('Failed to save checklist to localStorage:', error);
            }
        }

        // Helper function to get checklist from current DOM
        function getCurrentChecklist() {
            const checklist = [];
            const items = document.querySelectorAll('.checklist-item');
            items.forEach(item => {
                const text = item.querySelector('.checklist-text').textContent;
                const completed = item.querySelector('.checkbox').classList.contains('checked');
                checklist.push({ text, completed });
            });
            return checklist;
        }

        // Apply saved settings IMMEDIATELY before DOM loads to prevent flash
        (function applySettingsEarly() {
            // Load and render checklist instantly from localStorage
            const savedChecklist = localStorage.getItem('warRoomChecklist');
            if (savedChecklist) {
                try {
                    const checklist = JSON.parse(savedChecklist);
                    // Wait for DOM to be ready but before DOMContentLoaded
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', function renderChecklistEarly() {
                            const container = document.getElementById('checklistContainer');
                            if (container && container.children.length === 0) {
                                checklist.forEach(item => {
                                    const checklistItem = document.createElement('div');
                                    checklistItem.className = 'checklist-item';
                                    checklistItem.innerHTML = `
                                        <div class="checkbox ${item.completed ? 'checked' : ''}" onclick="toggleCheckbox(this)"></div>
                                        <div class="checklist-text ${item.completed ? 'completed' : ''}">${item.text}</div>
                                        <button class="delete-task-btn" onclick="deleteTask(this)" title="Delete task">×</button>
                                    `;
                                    container.appendChild(checklistItem);
                                });
                                updateProgress();
                            }
                        }, { once: true });
                    }
                } catch (error) {
                    console.error('Failed to load checklist from localStorage:', error);
                }
            }
            
            // Load and render notes instantly from localStorage
            const savedNotes = localStorage.getItem('warRoomNotes');
            const savedCurrentNoteId = localStorage.getItem('warRoomCurrentNoteId');
            if (savedNotes) {
                try {
                    const cachedNotes = JSON.parse(savedNotes);
                    const cachedNoteId = savedCurrentNoteId || 'note-1';
                    
                    // Wait for DOM to be ready
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', function renderNotesEarly() {
                            // Set global notes variable early
                            if (!window.notesLoaded) {
                                window.notes = cachedNotes;
                                window.currentNoteId = cachedNoteId;
                                
                                // Render notes list early
                                const notesList = document.getElementById('notesList');
                                if (notesList && notesList.children.length === 0) {
                                    Object.keys(cachedNotes).forEach(noteId => {
                                        const note = cachedNotes[noteId];
                                        const preview = note.content.replace(/<[^>]*>/g, '').substring(0, 50) + '...';
                                        
                                        const noteItem = document.createElement('div');
                                        noteItem.className = `note-item ${noteId === cachedNoteId ? 'active' : ''}`;
                                        noteItem.setAttribute('data-note-id', noteId);
                                        noteItem.innerHTML = `
                                            <div>
                                                <div class="note-title">${note.title}</div>
                                                <div class="note-preview">${preview}</div>
                                            </div>
                                            <div class="note-actions">
                                                <button class="note-delete-btn" onclick="deleteNote('${noteId}')">🗑️</button>
                                            </div>
                                        `;
                                        
                                        // Add click listener
                                        noteItem.addEventListener('click', (e) => {
                                            if (!e.target.classList.contains('note-delete-btn')) {
                                                selectNote(noteId);
                                            }
                                        });
                                        
                                        notesList.appendChild(noteItem);
                                    });
                                }
                                
                                // Don't populate text editor with cached content
                                // Let the server sync handle fresh content loading
                                
                                // Mark notes as loaded
                                window.notesLoaded = true;
                            }
                        }, { once: true });
                    }
                } catch (error) {
                    console.error('Failed to load notes from localStorage:', error);
                }
            }
            
            // Apply saved height instantly
            const savedHeight = localStorage.getItem('teamNotesHeight');
            if (savedHeight) {
                // Apply height directly to the element without !important
                setTimeout(() => {
                    const notesCard = document.getElementById('teamNotesCard');
                    if (notesCard) {
                        notesCard.style.height = savedHeight;
                    }
                }, 0);
            }
            
        })();

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Load checklist first
            await loadChecklist();
            
            // Initialize notes system
            await initNotesSystem();
            
            // Initialize resizable functionality
            initResizable();
            
            // Load existing assets
            await loadExistingAssets();
            
            // Load existing music
            await loadExistingMusic();
            
            
            // Load saved height (already applied via inline style, just verify)
            const savedHeight = localStorage.getItem('teamNotesHeight');
            if (savedHeight) {
                const notesCard = document.getElementById('teamNotesCard');
                if (notesCard) {
                    // Only set height, not min/max to avoid conflicts
                    notesCard.style.height = savedHeight;
                }
            } else {
                // Only reload note sizes if no custom height was saved
                // This prevents the snap when user has a custom size
                reloadNoteSizes();
            }
        });

        // Enter key to add tasks
        document.getElementById('newTaskInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addTask();
            }
        });

        // Notes System Functions
        let currentNoteId = window.currentNoteId || 'note-1';
        let notes = window.notes || {};

        async function initNotesSystem() {
            // Use cached notes if available (set by early loading)
            if (window.notesLoaded || Object.keys(notes).length > 0) {
                console.log('Using cached notes from localStorage');
                // Still sync with server in background
                syncNotesWithServer();
            } else {
                // Load from server if no cache
                try {
                    const response = await fetch('/api/war-room/notes');
                    if (response.ok) {
                        notes = await response.json();
                        // Save to localStorage for next time
                        localStorage.setItem('warRoomNotes', JSON.stringify(notes));
                    } else {
                        notes = {};
                    }
                } catch (error) {
                    console.log('Could not load notes from server:', error);
                    notes = {};
                }
            }

            // Initialize with empty note if none exist
            if (Object.keys(notes).length === 0) {
                notes['note-1'] = {
                    title: 'New Note',
                    content: ''
                };
                currentNoteId = 'note-1';
                // Save the default note to server
                await saveNotesToServer();
            }

            // Load notes list
            loadNotesList();
            
            // Load current note
            loadNote(currentNoteId);

            // Auto-save functionality
            document.getElementById('noteTitleInput').addEventListener('input', autoSaveNote);
            document.getElementById('noteContentEditor').addEventListener('input', autoSaveNote);
        }

        function loadNotesList() {
            const notesList = document.getElementById('notesList');
            notesList.innerHTML = '';

            Object.keys(notes).forEach(noteId => {
                const note = notes[noteId];
                const preview = note.content.replace(/<[^>]*>/g, '').substring(0, 50) + '...';
                
                const noteItem = document.createElement('div');
                noteItem.className = `note-item ${noteId === currentNoteId ? 'active' : ''}`;
                noteItem.setAttribute('data-note-id', noteId);
                noteItem.innerHTML = `
                    <div>
                        <div class="note-title">${note.title}</div>
                        <div class="note-preview">${preview}</div>
                    </div>
                    <div class="note-actions">
                        <button class="note-delete-btn" onclick="deleteNote('${noteId}')">🗑️</button>
                    </div>
                `;
                
                noteItem.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('note-delete-btn')) {
                        selectNote(noteId);
                    }
                });
                
                notesList.appendChild(noteItem);
            });
        }

        function selectNote(noteId) {
            currentNoteId = noteId;
            loadNote(noteId);
            loadNotesList(); // Refresh list to update active state
            
            // Save current note ID to localStorage
            try {
                localStorage.setItem('warRoomCurrentNoteId', currentNoteId);
            } catch (error) {
                console.error('Failed to save current note ID to localStorage:', error);
            }
        }

        function loadNote(noteId) {
            const note = notes[noteId];
            if (note) {
                document.getElementById('noteTitleInput').value = note.title;
                document.getElementById('noteContentEditor').innerHTML = note.content;
            }
        }

        async function createNewNote() {
            const noteId = 'note-' + Date.now();
            const title = '📝 New Note';
            
            notes[noteId] = {
                title: title,
                content: '<p>Start writing your note here...</p>'
            };
            
            selectNote(noteId);
            await saveNotesToServer();
        }

        async function deleteNote(noteId) {
            if (Object.keys(notes).length <= 1) {
                alert('You must have at least one note!');
                return;
            }
            
            if (confirm('Are you sure you want to delete this note?')) {
                delete notes[noteId];
                
                // If we deleted the current note, select another one
                if (noteId === currentNoteId) {
                    const remainingNotes = Object.keys(notes);
                    if (remainingNotes.length > 0) {
                        selectNote(remainingNotes[0]);
                    }
                }
                
                // Update the notes list UI to reflect the deletion
                loadNotesList();
                
                await saveNotesToServer();
            }
        }

        function autoSaveNote() {
            if (currentNoteId && notes[currentNoteId]) {
                notes[currentNoteId].title = document.getElementById('noteTitleInput').value;
                notes[currentNoteId].content = document.getElementById('noteContentEditor').innerHTML;
                saveNotesToServer();
                
                // Update the notes list to reflect title changes
                loadNotesList();
            }
        }

        async function saveNotesToServer() {
            // Save to localStorage immediately for instant persistence
            try {
                localStorage.setItem('warRoomNotes', JSON.stringify(notes));
                localStorage.setItem('warRoomCurrentNoteId', currentNoteId);
            } catch (error) {
                console.error('Failed to save notes to localStorage:', error);
            }
            
            // Sync with server in background
            try {
                const response = await fetch('/api/war-room/notes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(notes)
                });
                
                if (response.ok) {
                    console.log('Notes saved to server successfully');
                } else {
                    console.error('Failed to save notes to server');
                }
            } catch (error) {
                console.error('Error saving notes to server:', error);
            }
        }
        
        // Background sync function for cached notes
        async function syncNotesWithServer() {
            try {
                const response = await fetch('/api/war-room/notes');
                if (response.ok) {
                    const serverNotes = await response.json();
                    
                    // Check if server has different data
                    if (JSON.stringify(serverNotes) !== JSON.stringify(notes)) {
                        console.log('Server notes differ from cached notes, updating cache');
                        notes = serverNotes;
                        localStorage.setItem('warRoomNotes', JSON.stringify(notes));
                        
                        // Reload UI if notes changed
                        loadNotesList();
                        loadNote(currentNoteId);
                    }
                }
            } catch (error) {
                console.log('Background sync failed, using cached notes:', error);
            }
        }


        // Text formatting functions
        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('noteContentEditor').focus();
        }

        function insertBulletList() {
            document.execCommand('insertUnorderedList', false, null);
            document.getElementById('noteContentEditor').focus();
        }

        function insertNumberList() {
            document.execCommand('insertOrderedList', false, null);
            document.getElementById('noteContentEditor').focus();
        }

        function insertEmoji(emoji) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                range.insertNode(document.createTextNode(emoji + ' '));
                range.collapse(false);
                selection.removeAllRanges();
                selection.addRange(range);
            }
            document.getElementById('noteContentEditor').focus();
        }

        // Note size reload functionality
        function reloadNoteSizes() {
            const notesCard = document.getElementById('teamNotesCard');
            const notesList = document.getElementById('notesList');
            const noteEditor = document.getElementById('noteEditor');
            const noteContentEditor = document.getElementById('noteContentEditor');
            
            if (notesCard && notesList && noteEditor && noteContentEditor) {
                // Only reload if no manual height is set
                const currentHeight = notesCard.style.height;
                if (!currentHeight || currentHeight === 'auto') {
                    // Force a reflow to recalculate sizes
                    notesList.style.height = 'auto';
                    noteEditor.style.height = 'auto';
                    noteContentEditor.style.height = 'auto';
                    
                    // Trigger a layout recalculation
                    void notesCard.offsetHeight;
                    
                    // Apply responsive sizing based on viewport
                    const viewportWidth = window.innerWidth;
                    const viewportHeight = window.innerHeight;
                    
                    if (viewportWidth <= 768) {
                        // Mobile layout
                        notesCard.style.minHeight = '400px';
                        notesCard.style.maxHeight = '600px';
                        notesList.style.maxHeight = '150px';
                        noteContentEditor.style.minHeight = '150px';
                        noteContentEditor.style.maxHeight = 'none';
                    } else if (viewportWidth <= 1199) {
                        // Tablet layout
                        notesCard.style.minHeight = '500px';
                        notesCard.style.maxHeight = '700px';
                        notesList.style.maxHeight = '180px';
                        noteContentEditor.style.minHeight = '200px';
                        noteContentEditor.style.maxHeight = 'none';
                    } else {
                        // Desktop layout
                        notesCard.style.minHeight = '500px';
                        notesCard.style.maxHeight = '800px';
                        notesList.style.maxHeight = '200px';
                        noteContentEditor.style.minHeight = '200px';
                        noteContentEditor.style.maxHeight = 'none';
                    }
                    
                    // Adjust based on available viewport height
                    const availableHeight = viewportHeight - 200; // Account for header and margins
                    const maxCardHeight = Math.min(800, availableHeight * 0.8);
                    notesCard.style.maxHeight = maxCardHeight + 'px';
                }
                
                // Show feedback
                const button = document.querySelector('.size-reload-btn');
                const originalText = button.textContent;
                button.textContent = '✅ Reloaded!';
                button.style.background = 'rgba(81, 207, 102, 0.8)';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = 'rgba(64, 164, 255, 0.8)';
                }, 1500);
                
                console.log('Note sizes reloaded for viewport:', window.innerWidth + 'x' + window.innerHeight);
            }
        }

        // Auto-reload sizes on window resize (only if no custom height is saved)
        let resizeTimeout;
        window.addEventListener('resize', function() {
            const savedHeight = localStorage.getItem('teamNotesHeight');
            if (!savedHeight) {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    reloadNoteSizes();
                }, 250);
            }
        });

        // Don't auto-reload sizes when switching notes if user has custom height
        // This prevents the snap effect
        const originalSelectNote = selectNote;
        selectNote = function(noteId) {
            originalSelectNote(noteId);
            // Only reload if no custom height is set
            const savedHeight = localStorage.getItem('teamNotesHeight');
            if (!savedHeight) {
                setTimeout(() => {
                    reloadNoteSizes();
                }, 100);
            }
        };

        // Resizable functionality
        let isResizing = false;
        let startY = 0;
        let startHeight = 0;

        function initResizable() {
            const resizerHandle = document.getElementById('notesResizerHandle');
            const notesCard = document.getElementById('teamNotesCard');
            
            console.log('Initializing resizable:', { resizerHandle, notesCard });
            
            if (resizerHandle && notesCard) {
                // Mouse events
                resizerHandle.addEventListener('mousedown', startResize);
                document.addEventListener('mousemove', doResize);
                document.addEventListener('mouseup', stopResize);
                
                // Touch events for mobile
                resizerHandle.addEventListener('touchstart', startResizeTouch);
                document.addEventListener('touchmove', doResizeTouch);
                document.addEventListener('touchend', stopResize);
                
                // Prevent text selection during resize
                resizerHandle.addEventListener('selectstart', (e) => e.preventDefault());
                
                console.log('Resizable functionality initialized successfully');
            } else {
                console.error('Failed to initialize resizable - missing elements:', { resizerHandle, notesCard });
            }
        }

        function startResize(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Resize started!', e);
            
            isResizing = true;
            startY = e.clientY;
            startHeight = parseInt(document.defaultView.getComputedStyle(document.getElementById('teamNotesCard')).height, 10);
            
            const notesCard = document.getElementById('teamNotesCard');
            notesCard.classList.add('resizing');
            document.body.style.cursor = 'ns-resize';
            document.body.style.userSelect = 'none';
            
            // Add a temporary overlay to improve grab reliability
            const overlay = document.createElement('div');
            overlay.id = 'resize-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: transparent;
                cursor: ns-resize;
                z-index: 1000;
                pointer-events: all;
            `;
            document.body.appendChild(overlay);
            
            console.log('Resize started at height:', startHeight);
        }

        function startResizeTouch(e) {
            e.preventDefault();
            isResizing = true;
            startY = e.touches[0].clientY;
            startHeight = parseInt(document.defaultView.getComputedStyle(document.getElementById('teamNotesCard')).height, 10);
            
            document.getElementById('teamNotesCard').classList.add('resizing');
            document.body.style.userSelect = 'none';
        }

        function doResize(e) {
            if (!isResizing) return;
            e.preventDefault();
            
            const notesCard = document.getElementById('teamNotesCard');
            const currentY = e.clientY;
            const heightDiff = currentY - startY;
            const newHeight = startHeight + heightDiff;
            
            // Set minimum and maximum heights
            const minHeight = 300;
            const maxHeight = window.innerHeight * 0.8;
            
            if (newHeight >= minHeight && newHeight <= maxHeight) {
                // Force the height update with !important to override any conflicting styles
                notesCard.style.setProperty('height', newHeight + 'px', 'important');
                
                console.log('Resizing to height:', newHeight);
            }
        }

        function doResizeTouch(e) {
            if (!isResizing) return;
            e.preventDefault();
            
            const notesCard = document.getElementById('teamNotesCard');
            const currentY = e.touches[0].clientY;
            const heightDiff = currentY - startY;
            const newHeight = startHeight + heightDiff;
            
            // Set minimum and maximum heights
            const minHeight = 300;
            const maxHeight = window.innerHeight * 0.8;
            
            if (newHeight >= minHeight && newHeight <= maxHeight) {
                // Force the height update with !important to override any conflicting styles
                notesCard.style.setProperty('height', newHeight + 'px', 'important');
                
                console.log('Touch resizing to height:', newHeight);
            }
        }

        function stopResize() {
            if (!isResizing) return;
            
            isResizing = false;
            document.getElementById('teamNotesCard').classList.remove('resizing');
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            
            // Remove the overlay
            const overlay = document.getElementById('resize-overlay');
            if (overlay) {
                overlay.remove();
            }
            
            // Save the new height to localStorage
            const notesCard = document.getElementById('teamNotesCard');
            const currentHeight = notesCard.style.getPropertyValue('height') || notesCard.style.height;
            localStorage.setItem('teamNotesHeight', currentHeight);
            
            console.log('Notes box resized to:', currentHeight);
        }
    </script>
</body>
</html>
