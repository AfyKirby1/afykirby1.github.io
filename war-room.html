<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- ✅ SECURITY FIX (VULN-006): Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: blob:; connect-src 'self' ws://localhost:1234 ws://127.0.0.1:1234; base-uri 'self'; form-action 'self';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Referrer-Policy" content="no-referrer">
    
    <title>The War Room - DCS</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(45deg, #1a4d5c, #2d5a3f, #4a2d52, #1e3a5f);
            background-size: 400% 400%;
            animation: aurora 15s ease infinite;
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse at 20% 30%, rgba(100, 200, 180, 0.3) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 60%, rgba(180, 100, 150, 0.3) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 80%, rgba(100, 150, 200, 0.3) 0%, transparent 50%);
            animation: shimmer 10s ease-in-out infinite alternate;
            pointer-events: none;
        }

        @keyframes aurora {
            0% { background-position: 0% 50%; }
            25% { background-position: 50% 75%; }
            50% { background-position: 100% 50%; }
            75% { background-position: 50% 25%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes shimmer {
            0% { opacity: 0.5; transform: translateY(0); }
            100% { opacity: 0.8; transform: translateY(-20px); }
        }
        
        /* Header styling */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px 20px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-arrow {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            font-size: 0.9rem;
            font-weight: 500;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 20px;
            box-shadow: 0 4px 16px 0 rgba(31, 38, 135, 0.2);
            text-decoration: none;
            display: inline-block;
        }

        .back-arrow:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(31, 38, 135, 0.3);
        }

        .war-room-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.95);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* Main content */
        .main-content {
            margin-top: 80px;
            padding: 20px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        /* War room grid */
        .war-room-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Card styling */
        .war-room-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            transition: all 0.3s ease;
        }

        .war-room-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.5);
        }

        .card-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Checklist section */
        .checklist-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .checklist-item:last-child {
            border-bottom: none;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .checkbox.checked {
            background: #51cf66;
            border-color: #51cf66;
        }

        .checkbox.checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .checklist-text {
            flex: 1;
            color: rgba(255, 255, 255, 0.9);
        }

        .checklist-text.completed {
            text-decoration: line-through;
            opacity: 0.6;
        }

        /* Add item form */
        .add-item-form {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .add-item-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.95);
            padding: 10px 15px;
            border-radius: 12px;
            font-family: inherit;
        }

        .add-item-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .add-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .add-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* Notes section */
        .notes-textarea {
            width: 100%;
            min-height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 12px;
            font-family: inherit;
            resize: vertical;
        }

        .notes-textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Image upload section */
        .image-upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .image-upload-area:hover {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.05);
        }

        .image-upload-area.dragover {
            border-color: #51cf66;
            background: rgba(81, 207, 102, 0.1);
        }

        .upload-text {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.9rem;
        }

        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .image-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.1);
        }

        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(239, 68, 68, 0.8);
            border: none;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-item .download-btn {
            position: absolute;
            top: 5px;
            right: 35px;
            background: rgba(81, 207, 102, 0.8);
            border: none;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .image-item .download-btn:hover {
            background: rgba(81, 207, 102, 1);
            transform: scale(1.1);
        }

        /* Progress section */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #51cf66, #40a4ff);
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .progress-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            text-align: center;
        }

        /* Hidden file input */
        .hidden-input {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="admin.html" class="back-arrow">← Back to Admin</a>
        <div class="war-room-title">⚔️ The War Room</div>
        <div></div>
    </div>

    <div class="main-content">
        <div class="war-room-grid">
            <!-- Game Development Checklist -->
            <div class="war-room-card">
                <div class="card-title">
                    📋 Game Development Checklist
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="checklistProgress" style="width: 40%;"></div>
                </div>
                <div class="progress-text" id="progressText">5 of 12 tasks completed</div>
                
                <div id="checklistContainer">
                    <div class="checklist-item">
                        <div class="checkbox checked" onclick="toggleCheckbox(this)"></div>
                        <div class="checklist-text completed">Set up project repository</div>
                    </div>
                    <div class="checklist-item">
                        <div class="checkbox checked" onclick="toggleCheckbox(this)"></div>
                        <div class="checklist-text completed">Create basic game structure</div>
                    </div>
                    <div class="checklist-item">
                        <div class="checkbox checked" onclick="toggleCheckbox(this)"></div>
                        <div class="checklist-text completed">Design character sprites</div>
                    </div>
                    <div class="checklist-item">
                        <div class="checkbox checked" onclick="toggleCheckbox(this)"></div>
                        <div class="checklist-text completed">Implement player movement</div>
                    </div>
                    <div class="checklist-item">
                        <div class="checkbox checked" onclick="toggleCheckbox(this)"></div>
                        <div class="checklist-text completed">Add world textures</div>
                    </div>
                    <div class="checklist-item">
                        <div class="checkbox" onclick="toggleCheckbox(this)"></div>
                        <div class="checklist-text">Implement combat system</div>
                    </div>
                    <div class="checklist-item">
                        <div class="checkbox" onclick="toggleCheckbox(this)"></div>
                        <div class="checklist-text">Add NPC interactions</div>
                    </div>
                    <div class="checklist-item">
                        <div class="checkbox" onclick="toggleCheckbox(this)"></div>
                        <div class="checklist-text">Create inventory system</div>
                    </div>
                    <div class="checklist-item">
                        <div class="checkbox" onclick="toggleCheckbox(this)"></div>
                        <div class="checklist-text">Implement multiplayer networking</div>
                    </div>
                    <div class="checklist-item">
                        <div class="checkbox" onclick="toggleCheckbox(this)"></div>
                        <div class="checklist-text">Add audio system</div>
                    </div>
                    <div class="checklist-item">
                        <div class="checkbox" onclick="toggleCheckbox(this)"></div>
                        <div class="checklist-text">Create save/load functionality</div>
                    </div>
                    <div class="checklist-item">
                        <div class="checkbox" onclick="toggleCheckbox(this)"></div>
                        <div class="checklist-text">Polish and bug fixes</div>
                    </div>
                </div>

                <div class="add-item-form">
                    <input type="text" class="add-item-input" placeholder="Add new task..." id="newTaskInput">
                    <button class="add-btn" onclick="addTask()">Add</button>
                </div>
            </div>

            <!-- Team Notes -->
            <div class="war-room-card">
                <div class="card-title">
                    📝 Team Notes & Ideas
                </div>
                <textarea class="notes-textarea" placeholder="Add your ideas, notes, and thoughts here..." id="teamNotes">🎮 GAME DEVELOPMENT NOTES

📋 CURRENT PRIORITIES:
• Combat system needs balancing
• Multiplayer sync issues to resolve
• Audio implementation pending

💡 IDEAS:
• Add day/night cycle for atmosphere
• Implement weather effects
• Create mini-games for NPCs

🐛 BUGS TO FIX:
• Player sometimes clips through walls
• Inventory UI glitch on mobile
• Save file corruption issue

🎨 ART ASSETS NEEDED:
• More character animations
• Environmental particle effects
• UI icons and buttons

📊 PROGRESS TRACKING:
• World building: 70% complete
• Character development: 60% complete
• Audio implementation: 30% complete</textarea>
            </div>

            <!-- Asset Gallery -->
            <div class="war-room-card">
                <div class="card-title">
                    🖼️ Asset Gallery
                </div>
                <div class="image-upload-area" onclick="document.getElementById('imageInput').click()" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <div class="upload-text">📁 Drop images here or click to upload</div>
                    <div class="upload-hint">PNG, JPG, GIF up to 10MB each</div>
                </div>
                <input type="file" id="imageInput" class="hidden-input" multiple accept="image/*" onchange="handleImageUpload(event)">
                
                <div class="image-gallery" id="imageGallery">
                    <div class="image-item">
                        <img src="dcs.png" alt="DCS Logo">
                        <button class="remove-btn" onclick="removeImage(this)">×</button>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="war-room-card">
                <div class="card-title">
                    ⚡ Quick Actions
                </div>
                <div style="display: grid; gap: 15px;">
                    <button class="add-btn" style="width: 100%; padding: 15px;" onclick="exportData()">📤 Export War Room Data</button>
                    <button class="add-btn" style="width: 100%; padding: 15px;" onclick="clearCompleted()">🧹 Clear Completed Tasks</button>
                    <button class="add-btn" style="width: 100%; padding: 15px;" onclick="saveToLocal()">💾 Save to Local Storage</button>
                    <button class="add-btn" style="width: 100%; padding: 15px;" onclick="loadFromLocal()">📥 Load from Local Storage</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Checklist functionality
        function toggleCheckbox(checkbox) {
            checkbox.classList.toggle('checked');
            const text = checkbox.nextElementSibling;
            text.classList.toggle('completed');
            updateProgress();
        }

        function addTask() {
            const input = document.getElementById('newTaskInput');
            const text = input.value.trim();
            if (text) {
                const container = document.getElementById('checklistContainer');
                const newItem = document.createElement('div');
                newItem.className = 'checklist-item';
                newItem.innerHTML = `
                    <div class="checkbox" onclick="toggleCheckbox(this)"></div>
                    <div class="checklist-text">${text}</div>
                `;
                container.appendChild(newItem);
                input.value = '';
                updateProgress();
            }
        }

        function updateProgress() {
            const checkboxes = document.querySelectorAll('.checkbox');
            const checkedBoxes = document.querySelectorAll('.checkbox.checked');
            const progress = (checkedBoxes.length / checkboxes.length) * 100;
            
            document.getElementById('checklistProgress').style.width = progress + '%';
            document.getElementById('progressText').textContent = 
                `${checkedBoxes.length} of ${checkboxes.length} tasks completed`;
        }

        // Image upload functionality with filesystem storage
        function handleImageUpload(event) {
            const files = event.target.files;
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    uploadImageToServer(file);
                }
            }
        }

        function handleDrop(event) {
            event.preventDefault();
            const uploadArea = event.currentTarget;
            uploadArea.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    uploadImageToServer(file);
                }
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        async function uploadImageToServer(file) {
            const formData = new FormData();
            formData.append('image', file);
            formData.append('warRoomId', 'default'); // You can customize this per project
            
            try {
                const response = await fetch('/api/war-room/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    addImageToGallery(result.filename, result.originalName);
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Failed to upload image. Please try again.');
            }
        }

        function addImageToGallery(filename, originalName) {
            const gallery = document.getElementById('imageGallery');
            const newItem = document.createElement('div');
            newItem.className = 'image-item';
            newItem.innerHTML = `
                <img src="/api/war-room/image/${filename}" alt="${originalName}" loading="lazy">
                <button class="remove-btn" onclick="removeImage('${filename}', this)">×</button>
                <button class="download-btn" onclick="downloadImage('${filename}', '${originalName}')" title="Download full quality">⬇️</button>
            `;
            gallery.appendChild(newItem);
        }

        async function removeImage(filename, button) {
            if (confirm('Are you sure you want to delete this image?')) {
                try {
                    const response = await fetch(`/api/war-room/delete-image/${filename}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        button.parentElement.remove();
                    } else {
                        throw new Error('Delete failed');
                    }
                } catch (error) {
                    console.error('Delete error:', error);
                    alert('Failed to delete image. Please try again.');
                }
            }
        }

        async function downloadImage(filename, originalName) {
            try {
                const response = await fetch(`/api/war-room/download-image/${filename}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = originalName;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    throw new Error('Download failed');
                }
            } catch (error) {
                console.error('Download error:', error);
                alert('Failed to download image. Please try again.');
            }
        }

        // Quick actions
        function exportData() {
            const data = {
                checklist: Array.from(document.querySelectorAll('.checklist-item')).map(item => ({
                    text: item.querySelector('.checklist-text').textContent,
                    completed: item.querySelector('.checkbox').classList.contains('checked')
                })),
                notes: document.getElementById('teamNotes').value
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'war-room-data.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function clearCompleted() {
            const completedItems = document.querySelectorAll('.checklist-item .checkbox.checked');
            completedItems.forEach(checkbox => {
                checkbox.parentElement.remove();
            });
            updateProgress();
        }

        function saveToLocal() {
            const data = {
                checklist: Array.from(document.querySelectorAll('.checklist-item')).map(item => ({
                    text: item.querySelector('.checklist-text').textContent,
                    completed: item.querySelector('.checkbox').classList.contains('checked')
                })),
                notes: document.getElementById('teamNotes').value
            };
            localStorage.setItem('warRoomData', JSON.stringify(data));
            alert('War Room data saved to local storage!');
        }

        function loadFromLocal() {
            const data = localStorage.getItem('warRoomData');
            if (data) {
                const parsed = JSON.parse(data);
                
                // Load notes
                document.getElementById('teamNotes').value = parsed.notes || '';
                
                // Load checklist
                const container = document.getElementById('checklistContainer');
                container.innerHTML = '';
                parsed.checklist.forEach(item => {
                    const newItem = document.createElement('div');
                    newItem.className = 'checklist-item';
                    newItem.innerHTML = `
                        <div class="checkbox ${item.completed ? 'checked' : ''}" onclick="toggleCheckbox(this)"></div>
                        <div class="checklist-text ${item.completed ? 'completed' : ''}">${item.text}</div>
                    `;
                    container.appendChild(newItem);
                });
                
                updateProgress();
                alert('War Room data loaded from local storage!');
            } else {
                alert('No saved data found in local storage.');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateProgress();
            
            // Auto-save notes
            document.getElementById('teamNotes').addEventListener('input', function() {
                clearTimeout(this.saveTimeout);
                this.saveTimeout = setTimeout(() => {
                    localStorage.setItem('warRoomNotes', this.value);
                }, 1000);
            });
            
            // Load saved notes
            const savedNotes = localStorage.getItem('warRoomNotes');
            if (savedNotes) {
                document.getElementById('teamNotes').value = savedNotes;
            }
        });

        // Enter key to add tasks
        document.getElementById('newTaskInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addTask();
            }
        });
    </script>
</body>
</html>
